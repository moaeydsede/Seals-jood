<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MATGR MO | الأمين 9 (ويب)</title>
  <link rel="stylesheet" href="styles.css" />

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div id="appRoot">
    <section id="loginPage" class="center">
      <div class="card authCard">
        <div class="brandRow">
          <div class="brandMark">م</div>
          <div>
            <div class="brandTitle">MATGR MO</div>
            <div class="brandSub">POS + محاسبة (بدون ضرائب) • Excel • PDF</div>
          </div>
        </div>

        <h2 class="h2">تسجيل الدخول</h2>
        <div class="field">
          <label>البريد الإلكتروني</label>
          <input id="loginEmail" type="email" placeholder="admin@erp.local" />
        </div>
        <div class="field">
          <label>كلمة المرور</label>
          <input id="loginPassword" type="password" placeholder="••••••••" />
        </div>
        <button class="btn primary" id="btnLogin">دخول</button>
        <div class="hint" id="loginError"></div>
      </div>
      <div class="footerNote">Admin / Accountant / Cashier • سجل عمليات • تقارير منفصلة</div>
    </section>

    <section id="shell" class="shell" style="display:none;">
      <div id="drawerBackdrop" class="drawerBackdrop" style="display:none;"></div>

      <aside class="sidebar" id="sidebar">
        <div class="sideTop">
          <div class="brandRow compact">
            <div class="brandMark sm" id="companyLogoMini">م</div>
            <div class="brandText">
              <div class="brandTitle" id="companyNameMini">MATGR MO</div>
              <div class="brandSub" id="companyBranchMini">فرع واحد</div>
            </div>
          </div>
          <div class="userBox">
            <div class="userLine"><span id="userEmail"></span></div>
            <div class="userLine small">الدور: <b id="userRole"></b></div>
          </div>
        </div>

        <nav class="nav">
          <button class="navBtn" data-view="home">الرئيسية</button>
          <button class="navBtn" data-view="pos">نقطة البيع (POS)</button>

          <div class="navGroupTitle">فواتير</div>
          <button class="navBtn" data-view="salesInvoices">فواتير المبيعات</button>
          <button class="navBtn" data-view="salesReturns">مرتجع المبيعات</button>
          <button class="navBtn" data-view="purchaseInvoices">فواتير المشتريات</button>
          <button class="navBtn" data-view="purchaseReturns">مرتجع المشتريات</button>

          <div class="navGroupTitle">إعدادات</div>
          <button class="navBtn" data-view="items">دليل المواد</button>
          <button class="navBtn" data-view="customers">دليل العملاء</button>
          <button class="navBtn" data-view="accounts">دليل الحسابات</button>

          <div class="navGroupTitle">تقارير</div>
          <button class="navBtn" data-view="reportsInventory">تقارير مخزنية</button>
          <button class="navBtn" data-view="reportsFinancial">تقارير مالية</button>

          <div class="navGroupTitle">إدارة</div>
          <button class="navBtn" data-view="company">بيانات الشركة</button>
          <button class="navBtn" data-view="audit">سجل العمليات</button>
        </nav>

        <div class="sideBottom">
          <button class="btn ghost" id="btnAnnualClose">إقفال سنة وتدوير أرصدة</button>
          <button class="btn danger" id="btnLogout">تسجيل خروج</button>
        </div>
      </aside>

      <main class="main">
        <header class="topbar">
          <div class="topLeft">
            <button class="hamburger" id="btnHamburger">☰</button>
            <div class="pageTitle" id="pageTitle">الرئيسية</div>
          </div>
          <div class="topRight">
            <div class="pill" id="periodPill">الفترة: مفتوحة</div>
          </div>
        </header>

        <div class="content">
          <div class="view" id="view_home">
            <div class="grid2">
              <div class="card">
                <div class="cardTitle">اختصارات</div>
                <div class="actionsGrid">
                  <button class="tile" data-go="pos">فتح POS</button>
                  <button class="tile" data-go="salesInvoices">فواتير المبيعات</button>
                  <button class="tile" data-go="reportsInventory">تقارير المخزون</button>
                  <button class="tile" data-go="reportsFinancial">التقارير المالية</button>
                  <button class="tile" data-go="company">بيانات الشركة</button>
                </div>
              </div>

              <div class="card">
                <div class="cardTitle">تنبيه الفترة المحاسبية</div>
                <div class="hint" id="periodHint">...</div>
              </div>

              <div class="card">
                <div class="cardTitle">ملخص سريع</div>
                <div class="kpiRow">
                  <div class="kpi"><div class="kpiLabel">عدد المواد</div><div class="kpiValue" id="kpiItems">-</div></div>
                  <div class="kpi"><div class="kpiLabel">عدد العملاء</div><div class="kpiValue" id="kpiCustomers">-</div></div>
                  <div class="kpi"><div class="kpiLabel">فواتير اليوم</div><div class="kpiValue" id="kpiInvoicesToday">-</div></div>
                </div>
                <div class="hint">بدون ضرائب نهائياً • يمنع البيع إذا الكمية لا تسمح</div>
              </div>
            </div>
          </div>

          <div class="view" id="view_pos" style="display:none;">
            <div class="grid2">
              <div class="card">
                <div class="cardTitle">POS (بيع / مرتجع / مشتريات)</div>

                <div class="row3">
                  <div class="field">
                    <label>نوع العملية</label>
                    <select id="posMode">
                      <option value="sale">بيع</option>
                      <option value="sale_return">مرتجع مبيعات</option>
                      <option value="purchase">مشتريات</option>
                      <option value="purchase_return">مرتجع مشتريات</option>
                    </select>
                  </div>

                  <div class="field">
                    <label>الطرف</label>
                    <select id="posParty"></select>
                    <div class="hint">للبيع: عميل • للمشتريات: مورد (يضاف لاحقاً)</div>
                  </div>

                  <div class="field">
                    <label>طريقة الدفع</label>
                    <select id="posPayMethod">
                      <option value="cash">كاش</option>
                      <option value="vodafone">فودافون</option>
                      <option value="insta">إنستا</option>
                      <option value="credit">آجل</option>
                    </select>
                  </div>
                </div>

                <div class="row2">
                  <div class="field"><label>المستودع</label><select id="posWarehouse"></select></div>
                  <div class="field"><label>ملاحظة</label><input id="posNote" placeholder="اختياري" /></div>
                </div>

                <div class="divider"></div>

                <div class="row3">
                  <div class="field"><label>اختر مادة</label><select id="posItem"></select></div>
                  <div class="field"><label>الكمية</label><input id="posQty" type="number" min="1" value="1" /></div>
                  <div class="field"><label>سعر (اختياري)</label><input id="posPriceOverride" type="number" min="0" placeholder="اتركه للسعر الافتراضي" /></div>
                </div>

                <button class="btn" id="btnAddLine">إضافة سطر</button>
                <div class="hint warn" id="posWarn"></div>

                <div class="tableWrap">
                  <table class="tbl" id="posTable">
                    <thead><tr><th>المادة</th><th>الوحدة</th><th>الكمية</th><th>سعر</th><th>الإجمالي</th><th></th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>

                <div class="totals">
                  <div class="totLine"><span>الإجمالي</span><b id="posTotal">0</b></div>
                  <div class="totLine"><span>خصم (رقم)</span><input id="posDiscAmt" type="number" value="0" min="0" /></div>
                  <div class="totLine"><span>خصم (%)</span><input id="posDiscPct" type="number" value="0" min="0" max="100" /></div>
                  <div class="totLine"><span>الصافي</span><b id="posNet">0</b></div>
                </div>

                <div class="row2">
                  <button class="btn primary" id="btnSaveInvoice">حفظ وترحيل</button>
                  <button class="btn" id="btnPrintInvoice">طباعة PDF/صورة</button>
                </div>
              </div>

              <div class="card">
                <div class="cardTitle">معاينة الفاتورة</div>
                <div id="invoicePreview" class="invoice">
                  <div class="invTop">
                    <div class="invLogo" id="invLogoBox">LOGO</div>
                    <div class="invHeader">
                      <div class="invCompany" id="invCompanyName">MATGR MO</div>
                      <div class="invContact" id="invContact">Contact Sales</div>
                      <div class="invPhone" id="invPhone">-</div>
                      <div class="invSocial" id="invSocial"></div>
                    </div>
                  </div>
                  <div class="invTitle" id="invDocTitle">فاتورة</div>
                  <div class="invMeta">
                    <div><b>رقم:</b> <span id="invNo">-</span></div>
                    <div><b>التاريخ:</b> <span id="invDate">-</span></div>
                    <div><b>الطرف:</b> <span id="invParty">-</span></div>
                  </div>
                  <table class="invTbl" id="invLines">
                    <thead><tr><th>رمز</th><th>اسم المادة</th><th>الكمية</th><th>الوحدة</th><th>السعر</th><th>القيمة</th></tr></thead>
                    <tbody></tbody>
                  </table>
                  <div class="invFoot">
                    <div class="invTotals">
                      <div><span>المجموع:</span> <b id="invSum">0</b></div>
                      <div><span>إجمالي الحسميات:</span> <b id="invDisc">0</b></div>
                      <div><span>المجموع النهائي:</span> <b id="invNet">0</b></div>
                    </div>
                    <div class="invNote" id="invFooterNote">شكراً لتعاملكم معنا</div>
                  </div>
                </div>
                <div class="hint">يدعم أسطر غير محدودة • بدون ضرائب</div>
              </div>
            </div>
          </div>

          <div class="view" id="view_salesInvoices" style="display:none;"></div>
          <div class="view" id="view_salesReturns" style="display:none;"></div>
          <div class="view" id="view_purchaseInvoices" style="display:none;"></div>
          <div class="view" id="view_purchaseReturns" style="display:none;"></div>

          <div class="view" id="view_items" style="display:none;">
            <div class="grid2">
              <div class="card">
                <div class="cardTitle">إضافة مادة</div>
                <div class="row2">
                  <div class="field"><label>كود المادة (اختياري)</label><input id="itemCode" placeholder="110001 أو باركود"/></div>
                  <div class="field"><label>اسم المادة</label><input id="itemName" placeholder="قماش سنجل"/></div>
                </div>
                <div class="row2">
                  <div class="field"><label>الوحدة</label><input id="itemUnit" placeholder="قطعة / متر"/></div>
                  <div class="field"><label>سعر البيع</label><input id="itemPrice" type="number" min="0" value="0"/></div>
                </div>
                <div class="row2">
                  <div class="field"><label>مستودع افتراضي</label><select id="itemWh"></select></div>
                  <div class="field"><label>كمية افتتاحية (اختياري)</label><input id="itemOpeningQty" type="number" min="0" value="0"/></div>
                </div>
                <button class="btn primary" id="btnAddItem">حفظ مادة</button>
                <div class="row2">
                  <button class="btn" id="btnItemsExport">تصدير Excel</button>
                  <button class="btn" id="btnItemsTemplate">تحميل قالب Excel</button>
                </div>
                <div class="field">
                  <label>استيراد Excel (مواد)</label>
                  <input type="file" id="itemsImportFile" accept=".xlsx,.xls"/>
                </div>
                <div class="hint" id="itemMsg"></div>
              </div>

              <div class="card">
                <div class="cardTitle">دليل المواد</div>
                <div class="row2">
                  <input class="search" id="itemsSearch" placeholder="بحث..." />
                  <button class="btn" id="btnRefreshItems">تحديث</button>
                </div>
                <div class="tableWrap">
                  <table class="tbl" id="itemsTable">
                    <thead><tr><th>الكود</th><th>الاسم</th><th>الوحدة</th><th>السعر</th><th></th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="view" id="view_customers" style="display:none;">
            <div class="grid2">
              <div class="card">
                <div class="cardTitle">إضافة عميل</div>
                <div class="row2">
                  <div class="field"><label>اسم العميل</label><input id="custName" placeholder="محمد أحمد"/></div>
                  <div class="field"><label>هاتف (اختياري)</label><input id="custPhone" placeholder="01..."/></div>
                </div>
                <div class="row2">
                  <div class="field"><label>العنوان (اختياري)</label><input id="custAddress" placeholder="القاهرة..."/></div>
                  <div class="field"><label>ملاحظة (اختياري)</label><input id="custNote" placeholder="..."/></div>
                </div>
                <button class="btn primary" id="btnAddCustomer">حفظ عميل</button>
                <div class="row2">
                  <button class="btn" id="btnCustomersExport">تصدير Excel</button>
                  <button class="btn" id="btnCustomersTemplate">تحميل قالب Excel</button>
                </div>
                <div class="field">
                  <label>استيراد Excel (عملاء)</label>
                  <input type="file" id="customersImportFile" accept=".xlsx,.xls"/>
                </div>
                <div class="hint" id="custMsg"></div>
              </div>

              <div class="card">
                <div class="cardTitle">دليل العملاء</div>
                <div class="row2">
                  <input class="search" id="customersSearch" placeholder="بحث..." />
                  <button class="btn" id="btnRefreshCustomers">تحديث</button>
                </div>
                <div class="tableWrap">
                  <table class="tbl" id="customersTable">
                    <thead><tr><th>الاسم</th><th>الهاتف</th><th>العنوان</th><th></th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="view" id="view_accounts" style="display:none;">
            <div class="grid2">
              <div class="card">
                <div class="cardTitle">إضافة حساب (من داخل البرنامج)</div>
                <div class="row2">
                  <div class="field"><label>كود الحساب</label><input id="accCode" placeholder="14001"/></div>
                  <div class="field"><label>اسم الحساب</label><input id="accName" placeholder="خزنة كاش"/></div>
                </div>
                <div class="row2">
                  <div class="field"><label>تابع لـ (Parent)</label><input id="accParent" placeholder="مثلاً 14 أو اتركه فارغ"/></div>
                  <div class="field"><label>المستوى (level)</label><input id="accLevel" type="number" min="1" value="1"/></div>
                </div>
                <div class="row2">
                  <div class="field"><label>النوع</label>
                    <select id="accType">
                      <option value="asset">أصول</option><option value="liability">خصوم</option><option value="equity">حقوق ملكية</option>
                      <option value="revenue">إيرادات</option><option value="purchase">مشتريات</option><option value="expense">مصاريف</option><option value="cogs">تكلفة</option>
                    </select>
                  </div>
                  <div class="field"><label>ترحيل (allowPost)</label>
                    <select id="accAllowPost"><option value="false">لا (تجميعي)</option><option value="true">نعم (يقبل قيود)</option></select>
                  </div>
                </div>
                <button class="btn primary" id="btnAddAccount">حفظ حساب</button>
                <div class="hint" id="accMsg"></div>
              </div>

              <div class="card">
                <div class="cardTitle">شجرة الحسابات</div>
                <div class="row2">
                  <button class="btn" id="btnRefreshAccounts">تحديث</button>
                  <button class="btn" id="btnAccountsExport">تصدير Excel</button>
                </div>
                <div class="tree" id="accountsTree"></div>
              </div>
            </div>
          </div>

          <div class="view" id="view_reportsInventory" style="display:none;">
            <div class="card">
              <div class="cardTitle">تقارير مخزنية (منفصلة)</div>
              <div class="row3">
                <div class="field"><label>المستودع</label><select id="repWh"></select></div>
                <div class="field"><label>من تاريخ</label><input id="repFrom" type="date"/></div>
                <div class="field"><label>إلى تاريخ</label><input id="repTo" type="date"/></div>
              </div>
              <div class="row2">
                <button class="btn primary" id="btnStockBalance">رصيد المخزون</button>
                <button class="btn" id="btnItemMovement">حركة مادة</button>
              </div>
              <div class="divider"></div>
              <div class="reportBox">
                <div class="reportTitle" id="invReportTitle">-</div>
                <div class="row2">
                  <button class="btn" id="btnInvExportExcel">تصدير Excel</button>
                  <button class="btn" id="btnInvExportPDF">تصدير PDF</button>
                </div>
                <div class="tableWrap">
                  <table class="tbl" id="invReportTable"><thead></thead><tbody></tbody></table>
                </div>
              </div>
            </div>
          </div>

          <div class="view" id="view_reportsFinancial" style="display:none;">
            <div class="card">
              <div class="cardTitle">تقارير مالية (منفصلة)</div>
              <div class="row3">
                <div class="field"><label>من تاريخ</label><input id="finFrom" type="date"/></div>
                <div class="field"><label>إلى تاريخ</label><input id="finTo" type="date"/></div>
                <div class="field"><label>عرض</label>
                  <select id="finMode"><option value="trial">ميزان مراجعة</option><option value="daily">قيود يومية</option></select>
                </div>
              </div>
              <div class="row2">
                <button class="btn primary" id="btnRunFinancial">تشغيل التقرير</button>
                <button class="btn" id="btnFinExportExcel">تصدير Excel</button>
                <button class="btn" id="btnFinExportPDF">تصدير PDF</button>
              </div>
              <div class="divider"></div>
              <div class="reportBox" id="finReportBox">
                <div class="reportTitle" id="finReportTitle">-</div>
                <div class="tableWrap">
                  <table class="tbl" id="finReportTable"><thead></thead><tbody></tbody></table>
                </div>
              </div>
            </div>
          </div>

          <div class="view" id="view_company" style="display:none;">
            <div class="grid2">
              <div class="card">
                <div class="cardTitle">بيانات الشركة (من داخل البرنامج)</div>
                <div class="row2">
                  <div class="field"><label>اسم الشركة</label><input id="coName" /></div>
                  <div class="field"><label>العنوان</label><input id="coAddress" /></div>
                </div>
                <div class="row2">
                  <div class="field"><label>هاتف المبيعات</label><input id="coPhoneSales" /></div>
                  <div class="field"><label>ملاحظة أسفل الفاتورة</label><input id="coFooterNote" /></div>
                </div>
                <div class="row2">
                  <div class="field"><label>واتساب</label><input id="coWhatsapp" /></div>
                  <div class="field"><label>تيليجرام</label><input id="coTelegram" /></div>
                </div>
                <div class="row2">
                  <div class="field"><label>فيسبوك</label><input id="coFacebook" /></div>
                  <div class="field"><label>إظهار أيقونات التواصل</label>
                    <select id="coShowIcons"><option value="true">نعم</option><option value="false">لا</option></select>
                  </div>
                </div>
                <div class="divider"></div>
                <div class="field">
                  <label>شعار الشركة (بدون Storage)</label>
                  <input type="file" id="coLogoFile" accept="image/*" />
                  <div class="hint">يُحفظ داخل Firestore كـ DataURL.</div>
                </div>
                <button class="btn primary" id="btnSaveCompany">حفظ بيانات الشركة</button>
                <div class="hint" id="coMsg"></div>
              </div>

              <div class="card">
                <div class="cardTitle">معاينة</div>
                <div class="previewRow">
                  <div class="logoPreview" id="logoPreview">LOGO</div>
                  <div>
                    <div class="previewName" id="previewName">-</div>
                    <div class="previewSub" id="previewSub">-</div>
                  </div>
                </div>
                <div class="hint">هذه البيانات تظهر في الفاتورة تلقائياً.</div>
              </div>
            </div>
          </div>

          <div class="view" id="view_audit" style="display:none;">
            <div class="card">
              <div class="cardTitle">سجل العمليات (Audit Log)</div>
              <div class="row2">
                <button class="btn" id="btnRefreshAudit">تحديث</button>
                <button class="btn" id="btnClearAuditFilter">إلغاء فلترة</button>
              </div>
              <div class="tableWrap">
                <table class="tbl" id="auditTable">
                  <thead><tr><th>الوقت</th><th>المستخدم</th><th>العملية</th><th>الكيان</th><th>المعرف</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
              <div class="hint">يسجل: إضافة/تعديل/حذف + التاريخ والوقت.</div>
            </div>
          </div>

        </div>
      </main>
    </section>

    <div id="modalBackdrop" class="modalBackdrop" style="display:none;">
      <div class="modal">
        <div class="modalTitle" id="modalTitle">-</div>
        <div class="modalBody" id="modalBody"></div>
        <div class="modalActions">
          <button class="btn" id="modalCancel">إلغاء</button>
          <button class="btn primary" id="modalOk">موافق</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="app.js"></script>
</body>
</html>
