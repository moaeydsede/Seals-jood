<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0F766E" />
  <title>الأمين 9 — نقطة بيع ومحاسبة</title>
  <link rel="stylesheet" href="./styles.css" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='22' fill='%230F766E'/%3E%3Cpath d='M25 60 L45 30 L60 50 L75 25' stroke='white' stroke-width='10' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">
  <script type="module" src="./firebase.js"></script>
  <script type="module" src="./app.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <div id="app">
    <header class="topbar">
      <button class="icon-btn" id="btnMenu" aria-label="القائمة" title="القائمة">
        <span class="hamburger"></span>
      </button>
      <div class="brand">
        <div class="brand-badge">A9</div>
        <div class="brand-text">
          <div class="brand-title">الأمين 9</div>
          <div class="brand-sub">POS + محاسبة (بدون ضرائب) — فرع واحد</div>
        </div>
      </div>
      <div class="topbar-actions">
        <button class="chip" id="btnCompany">بيانات الشركة</button>
        <button class="chip chip-danger hidden" id="btnLogout">تسجيل خروج</button>
      </div>
    </header>

    <aside class="drawer" id="drawer">
      <div class="drawer-head">
        <div class="drawer-title">القائمة</div>
        <button class="icon-btn" id="btnCloseDrawer" aria-label="إغلاق" title="إغلاق">✕</button>
      </div>

      <nav class="nav">
        <button class="nav-item" data-route="home">الرئيسية</button>
        <button class="nav-item" data-route="pos">شاشة POS</button>
        <button class="nav-item" data-route="items">دليل المواد</button>
        <button class="nav-item" data-route="customers">دليل العملاء</button>
        <button class="nav-item" data-route="accounts">دليل الحسابات</button>
        <button class="nav-item" data-route="reports">التقارير</button>
        <button class="nav-item" data-route="audit">سجل العمليات</button>
        <button class="nav-item" data-route="settings">إعدادات المحاسبة</button>
        <div class="nav-divider"></div>
        <button class="nav-item nav-danger" id="navCloseYear">إقفال سنة وتدوير أرصدة</button>
      </nav>

      <div class="drawer-foot">
        <div class="small muted" id="userBadge">غير مسجل</div>
      </div>
    </aside>

    <main class="main" id="main">
      <section class="view" id="view-login">
        <div class="card narrow">
          <h1 class="h1">تسجيل الدخول</h1>
          <p class="muted">الدخول عبر Firebase. مثال: <bdi>admin@erp.local</bdi></p>
          <div class="form">
            <label>البريد الإلكتروني</label>
            <input id="loginEmail" type="email" placeholder="admin@erp.local" autocomplete="username" />
            <label>كلمة المرور</label>
            <input id="loginPassword" type="password" placeholder="Admin123" autocomplete="current-password" />
            <button class="btn primary" id="btnLogin">دخول</button>
            <div class="hint" id="loginHint"></div>
          </div>
        </div>
      </section>

      <section class="view hidden" id="view-home">
        <div class="grid">
          <button class="tile primary" data-route="pos">
            <div class="tile-title">شاشة POS</div>
            <div class="tile-sub">بيع سريع + طباعة فاتورة PDF/صورة</div>
          </button>
          <button class="tile" data-route="items">
            <div class="tile-title">دليل المواد</div>
            <div class="tile-sub">إضافة/تعديل/حذف + سعر بيع + وحدة</div>
          </button>
          <button class="tile" data-route="customers">
            <div class="tile-title">دليل العملاء</div>
            <div class="tile-sub">إضافة/تعديل/حذف</div>
          </button>
          <button class="tile" data-route="accounts">
            <div class="tile-title">دليل الحسابات</div>
            <div class="tile-sub">هيكل شجري + إضافة تفصيلية من داخل النظام</div>
          </button>
          <button class="tile" data-route="reports">
            <div class="tile-title">التقارير</div>
            <div class="tile-sub">أرصدة عملاء/موردين + حركة مادة + جرد</div>
          </button>
          <button class="tile" data-route="audit">
            <div class="tile-title">سجل العمليات</div>
            <div class="tile-sub">من أضاف/عدّل/حذف + وقت</div>
          </button>
          <button class="tile" id="tileAll">
            <div class="tile-title">كل الأزرار</div>
            <div class="tile-sub">شاشة تحتوي جميع الخيارات مثل الأمين</div>
          </button>
          <button class="tile" data-route="settings">
            <div class="tile-title">إعدادات المحاسبة</div>
            <div class="tile-sub">حسابات الترحيل الافتراضية + إقفال فترة</div>
          </button>
        </div>
      </section>

      <section class="view hidden" id="view-pos">
        <div class="view-head">
          <h2 class="h2">شاشة POS</h2>
          <div class="row gap">
            <button class="btn" id="btnNewSale">فاتورة جديدة</button>
            <button class="btn" id="btnOpenInvoices">عرض آخر الفواتير</button>
          </div>
        </div>

        <div class="pos">
          <div class="card">
            <div class="row wrap gap">
              <div class="field">
                <label>العميل</label>
                <select id="posCustomer"></select>
              </div>
              <div class="field">
                <label>طريقة الدفع</label>
                <select id="posPayMethod">
                  <option value="cash">كاش</option>
                  <option value="vodafone">فودافون</option>
                  <option value="insta">إنستا</option>
                  <option value="credit">آجل</option>
                </select>
              </div>
              <div class="field">
                <label>ملاحظات</label>
                <input id="posNote" type="text" placeholder="اختياري" />
              </div>
            </div>

            <div class="divider"></div>

            <div class="row wrap gap">
              <div class="field grow">
                <label>المادة</label>
                <select id="posItem"></select>
              </div>
              <div class="field">
                <label>الكمية</label>
                <input id="posQty" type="number" min="1" value="1" />
              </div>
              <div class="field">
                <label>السعر</label>
                <input id="posPrice" type="number" min="0" step="0.01" />
              </div>
              <button class="btn primary" id="btnAddLine">إضافة</button>
            </div>

            <div class="hint danger" id="posWarn"></div>

            <div class="table-wrap">
              <table class="table" id="posTable">
                <thead>
                  <tr>
                    <th>رمز</th>
                    <th>اسم المادة</th>
                    <th>الوحدة</th>
                    <th>الكمية</th>
                    <th>السعر</th>
                    <th>القيمة</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="row end gap">
              <div class="totals">
                <div class="tot-row"><span>الإجمالي</span><bdi id="posTotal">0.00</bdi></div>
              </div>
              <button class="btn primary" id="btnSaveInvoice">حفظ + طباعة</button>
            </div>
          </div>

          <div class="card">
            <h3 class="h3">معلومات سريعة</h3>
            <div class="kpi-grid">
              <div class="kpi">
                <div class="kpi-label">آخر فاتورة</div>
                <div class="kpi-val" id="kpiLastInvoice">—</div>
              </div>
              <div class="kpi">
                <div class="kpi-label">عدد مواد</div>
                <div class="kpi-val" id="kpiItems">—</div>
              </div>
              <div class="kpi">
                <div class="kpi-label">عدد عملاء</div>
                <div class="kpi-val" id="kpiCustomers">—</div>
              </div>
            </div>
            <div class="small muted">
              * منع البيع عند كمية صفر مفعل.
            </div>
          </div>
        </div>
      </section>

      <section class="view hidden" id="view-items">
        <div class="view-head">
          <h2 class="h2">دليل المواد</h2>
          <button class="btn primary" id="btnAddItem">إضافة مادة</button>
        </div>
        <div class="card">
          <div class="row wrap gap">
            <input class="grow" id="itemsSearch" placeholder="بحث بالاسم/الباركود/الكود..." />
            <select id="itemsWarehouseFilter"></select>
          </div>
          <div class="table-wrap">
            <table class="table" id="itemsTable">
              <thead>
                <tr>
                  <th>كود</th>
                  <th>الباركود</th>
                  <th>اسم المادة</th>
                  <th>الوحدة</th>
                  <th>سعر البيع</th>
                  <th>الكمية</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="small muted">* الكمية من المخزون (stock) للمستودع الافتراضي.</div>
        </div>
      </section>

      <section class="view hidden" id="view-customers">
        <div class="view-head">
          <h2 class="h2">دليل العملاء</h2>
          <button class="btn primary" id="btnAddCustomer">إضافة عميل</button>
        </div>
        <div class="card">
          <input id="customersSearch" placeholder="بحث بالاسم/الهاتف..." />
          <div class="table-wrap">
            <table class="table" id="customersTable">
              <thead>
                <tr>
                  <th>الاسم</th>
                  <th>الهاتف</th>
                  <th>العنوان</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="view hidden" id="view-accounts">
        <div class="view-head">
          <h2 class="h2">دليل الحسابات</h2>
          <button class="btn primary" id="btnAddAccount">إضافة حساب</button>
        </div>
        <div class="card">
          <div class="row wrap gap">
            <input class="grow" id="accountsSearch" placeholder="بحث بالكود/الاسم..." />
            <button class="btn" id="btnSeedAccounts">تأكيد الأساسيات</button>
          </div>
          <div class="tree" id="accountsTree"></div>
          <div class="small muted">
            * الحسابات الأساسية أنت أنشأتها على Firebase. يمكنك إضافة التفصيل من هنا لاحقًا.
          </div>
        </div>
      </section>

      <section class="view hidden" id="view-reports">
        <div class="view-head">
          <h2 class="h2">التقارير</h2>
        </div>
        <div class="grid">
          <div class="card">
            <h3 class="h3">أرصدة العملاء</h3>
            <button class="btn" id="btnRptCustomerBalances">عرض</button>
            <div class="table-wrap"><table class="table" id="rptCustomerBalances"><thead><tr><th>العميل</th><th>مدين</th><th>دائن</th><th>الرصيد</th></tr></thead><tbody></tbody></table></div>
          </div>
          <div class="card">
            <h3 class="h3">حركة مادة</h3>
            <div class="row gap wrap">
              <select id="rptItemSelect" class="grow"></select>
              <button class="btn" id="btnRptItemMoves">عرض</button>
            </div>
            <div class="table-wrap"><table class="table" id="rptItemMoves"><thead><tr><th>التاريخ</th><th>النوع</th><th>كمية</th><th>رقم</th></tr></thead><tbody></tbody></table></div>
          </div>
          <div class="card">
            <h3 class="h3">جرد المخزون</h3>
            <button class="btn" id="btnRptStock">عرض</button>
            <div class="table-wrap"><table class="table" id="rptStock"><thead><tr><th>المادة</th><th>الكمية</th></tr></thead><tbody></tbody></table></div>
          </div>
        </div>
      </section>

      <section class="view hidden" id="view-audit">
        <div class="view-head">
          <h2 class="h2">سجل العمليات</h2>
          <button class="btn" id="btnRefreshAudit">تحديث</button>
        </div>
        <div class="card">
          <div class="table-wrap">
            <table class="table" id="auditTable">
              <thead>
                <tr>
                  <th>الوقت</th>
                  <th>المستخدم</th>
                  <th>العملية</th>
                  <th>الكيان</th>
                  <th>معرّف</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="view hidden" id="view-settings">
        <div class="view-head">
          <h2 class="h2">إعدادات المحاسبة</h2>
          <button class="btn primary" id="btnSaveSettings">حفظ</button>
        </div>
        <div class="card">
          <h3 class="h3">حسابات الترحيل الافتراضية</h3>
          <div class="form grid2">
            <div class="field">
              <label>حساب العملاء (رقم)</label>
              <input id="setCustomersAcc" placeholder="12002" />
            </div>
            <div class="field">
              <label>حساب المبيعات (رقم)</label>
              <input id="setSalesAcc" placeholder="41" />
            </div>
            <div class="field">
              <label>حساب المخزون (رقم)</label>
              <input id="setInventoryAcc" placeholder="12001" />
            </div>
            <div class="field">
              <label>حساب تكلفة البضاعة (رقم) (اختياري)</label>
              <input id="setCogsAcc" placeholder="70001" />
            </div>
            <div class="field">
              <label>خزنة كاش (رقم)</label>
              <input id="setCashAcc" placeholder="14001" />
            </div>
            <div class="field">
              <label>خزنة فودافون (رقم)</label>
              <input id="setVodafoneAcc" placeholder="14002" />
            </div>
            <div class="field">
              <label>خزنة إنستا (رقم)</label>
              <input id="setInstaAcc" placeholder="14003" />
            </div>
            <div class="field">
              <label>حساب الموردين (رقم) (اختياري)</label>
              <input id="setSuppliersAcc" placeholder="21001" />
            </div>
          </div>

          <div class="divider"></div>

          <h3 class="h3">قفل الفترات</h3>
          <div class="form grid2">
            <div class="field">
              <label>ممنوع التعديل قبل تاريخ</label>
              <input id="setLockUntil" type="date" />
              <div class="small muted">القيد/الفاتورة قبل هذا التاريخ ستكون مقفلة، إلا إذا كان allowAdminOverride = true.</div>
            </div>
            <div class="field">
              <label>السماح للأدمن بالتعديل حتى بعد الإقفال</label>
              <select id="setAdminOverride">
                <option value="true">نعم</option>
                <option value="false">لا</option>
              </select>
            </div>
          </div>

          <div class="hint" id="settingsHint"></div>
        </div>
      </section>
    </main>

    <div class="modal hidden" id="modalBackdrop"></div>

    <div class="modal-card hidden" id="modalCompany">
      <div class="modal-head">
        <div class="modal-title">بيانات الشركة</div>
        <button class="icon-btn" data-close="modalCompany">✕</button>
      </div>
      <div class="modal-body">
        <div class="form grid2">
          <div class="field">
            <label>اسم الشركة</label>
            <input id="cmpName" placeholder="matgr mo" />
          </div>
          <div class="field">
            <label>هاتف المبيعات</label>
            <input id="cmpPhoneSales" placeholder="+2010..." />
          </div>
          <div class="field">
            <label>واتساب</label>
            <input id="cmpWhatsapp" placeholder="رابط أو رقم" />
          </div>
          <div class="field">
            <label>تيليجرام</label>
            <input id="cmpTelegram" placeholder="رابط" />
          </div>
          <div class="field">
            <label>فيسبوك</label>
            <input id="cmpFacebook" placeholder="رابط" />
          </div>
          <div class="field">
            <label>الموقع/العنوان</label>
            <input id="cmpAddress" placeholder="العنوان" />
          </div>
          <div class="field">
            <label>ملاحظة أسفل الفاتورة</label>
            <input id="cmpFooter" placeholder="شكراً لتعاملكم معنا" />
          </div>
          <div class="field">
            <label>نوع طباعة الفاتورة</label>
            <select id="cmpPrintDefault">
              <option value="A4">A4</option>
            </select>
          </div>
          <div class="field">
            <label>اللوجو (من داخل البرنامج)</label>
            <input id="cmpLogoFile" type="file" accept="image/*" />
            <div class="small muted">سيتم حفظ اللوجو داخل Firestore كصورة مضغوطة (بدون Storage).</div>
          </div>
          <div class="field">
            <label>إظهار أيقونات التواصل</label>
            <select id="cmpShowIcons">
              <option value="true">نعم</option>
              <option value="false">لا</option>
            </select>
          </div>
        </div>
        <div class="hint" id="companyHint"></div>
      </div>
      <div class="modal-foot">
        <button class="btn" data-close="modalCompany">إلغاء</button>
        <button class="btn primary" id="btnSaveCompany">حفظ</button>
      </div>
    </div>

    <div class="modal-card hidden" id="modalForm">
      <div class="modal-head">
        <div class="modal-title" id="modalFormTitle">—</div>
        <button class="icon-btn" data-close="modalForm">✕</button>
      </div>
      <div class="modal-body" id="modalFormBody"></div>
      <div class="modal-foot" id="modalFormFoot"></div>
    </div>

    <div class="modal-card hidden wide" id="modalInvoice">
      <div class="modal-head">
        <div class="modal-title">فاتورة</div>
        <button class="icon-btn" data-close="modalInvoice">✕</button>
      </div>
      <div class="modal-body">
        <div class="row end gap wrap">
          <button class="btn" id="btnDownloadPNG">تحميل صورة</button>
          <button class="btn primary" id="btnDownloadPDF">تحميل PDF</button>
        </div>
        <div class="invoice" id="invoiceArea"></div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>
</body>
</html>
