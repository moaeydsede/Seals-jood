<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jood kids seals — نظام المبيعات</title>
  <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgdmlld0JveD0iMCAwIDY0IDY0Ij4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iZyIgeDE9IjAiIHgyPSIxIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwIiBzdG9wLWNvbG9yPSIjNmVhOGZmIi8+PHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjM2RkYzk3Ii8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8cmVjdCB4PSI2IiB5PSI2IiB3aWR0aD0iNTIiIGhlaWdodD0iNTIiIHJ4PSIxNCIgZmlsbD0idXJsKCNnKSIvPgogIDxwYXRoIGQ9Ik0yMiAzNmM0IDYgMTYgNiAyMCAwIiBmaWxsPSJub25lIiBzdHJva2U9IiMwODEwMjIiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+CiAgPHBhdGggZD0iTTIyIDI2aDAiIHN0cm9rZT0iIzA4MTAyMiIgc3Ryb2tlLXdpZHRoPSI2IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KICA8cGF0aCBkPSJNNDIgMjZoMCIgc3Ryb2tlPSIjMDgxMDIyIiBzdHJva2Utd2lkdGg9IjYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8L3N2Zz4=">
  <meta name="theme-color" content="#0b1220" />
  <style>
/* Jood kids seals — Sales System (Arabic RTL)
   Minimal, clean, mobile-first. */
:root{
  --bg:#0b1220;
  --card:#111a2d;
  --card2:#0f1930;
  --text:#e9eefb;
  --muted:#a9b6d6;
  --line:rgba(255,255,255,.10);
  --accent:#6ea8ff;
  --danger:#ff5c7a;
  --ok:#3ddc97;
  --warn:#ffd36e;
  --shadow: 0 10px 25px rgba(0,0,0,.35);
  --radius:18px;
  --radius2:14px;
  --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Kufi Arabic", "Noto Sans Arabic", sans-serif;
}

*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0;
  font-family:var(--font);
  background: radial-gradient(1200px 700px at 80% -10%, rgba(110,168,255,.25), transparent 55%),
              radial-gradient(900px 500px at 10% 10%, rgba(61,220,151,.12), transparent 50%),
              var(--bg);
  color:var(--text);
}

a{ color:inherit; text-decoration:none; }
button,input,select,textarea{ font-family:inherit; }

.topbar{
  position:sticky; top:0; z-index:20;
  display:flex; align-items:center; gap:12px;
  padding:12px 14px;
  background: rgba(10,16,30,.75);
  backdrop-filter: blur(10px);
  border-bottom:1px solid var(--line);
}
.iconbtn{
  width:44px; height:44px;
  border-radius:14px;
  background:rgba(255,255,255,.06);
  border:1px solid var(--line);
  color:var(--text);
  font-size:18px;
}
.iconbtn:active{ transform: translateY(1px); }

.brand{ display:flex; flex-direction:column; gap:2px; min-width:0; }
.brand-title{ font-weight:800; letter-spacing:.2px; }
.brand-sub{ color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

.topbar-right{ margin-inline-start:auto; display:flex; align-items:center; gap:10px; }
.chip{
  padding:8px 10px; border-radius:999px;
  background:rgba(255,255,255,.06);
  border:1px solid var(--line);
  color:var(--muted);
  font-size:12px;
  max-width:55vw;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}

.btn{
  border:none; cursor:pointer;
  padding:10px 12px;
  border-radius:14px;
  background: linear-gradient(180deg, rgba(110,168,255,.95), rgba(110,168,255,.70));
  color:#081022;
  font-weight:800;
  box-shadow: 0 10px 20px rgba(110,168,255,.25);
}
.btn.ghost{
  background: rgba(255,255,255,.06);
  border:1px solid var(--line);
  box-shadow:none;
  color:var(--text);
}
.btn.danger{
  background: linear-gradient(180deg, rgba(255,92,122,.95), rgba(255,92,122,.70));
  color:#22050b;
  box-shadow: 0 10px 20px rgba(255,92,122,.20);
}
.btn.ok{
  background: linear-gradient(180deg, rgba(61,220,151,.95), rgba(61,220,151,.70));
  color:#042014;
  box-shadow: 0 10px 20px rgba(61,220,151,.18);
}
.btn.small{ padding:8px 10px; border-radius:12px; font-size:13px; }
.btn:active{ transform: translateY(1px); }

.sidebar{
  position:fixed; inset:0 auto 0 0;
  width:min(360px, 92vw);
  background: rgba(15,25,48,.92);
  backdrop-filter: blur(12px);
  border-inline-end:1px solid var(--line);
  transform: translateX(-105%);
  transition: transform .2s ease;
  z-index:30;
  display:flex; flex-direction:column;
}
.sidebar.open{ transform: translateX(0); }
.sidebar-head{
  display:flex; align-items:center; justify-content:space-between;
  padding:14px;
  border-bottom:1px solid var(--line);
}
.sidebar-title{ font-weight:900; }
.nav{ padding:10px; display:flex; flex-direction:column; gap:8px; overflow:auto; }
.nav a{
  display:flex; align-items:center; gap:10px;
  padding:12px;
  border-radius:14px;
  border:1px solid transparent;
  background: rgba(255,255,255,.04);
}
.nav a:hover{ border-color: rgba(110,168,255,.35); }
.nav a.active{ border-color: rgba(110,168,255,.65); background: rgba(110,168,255,.10); }
.nav .tag{
  margin-inline-start:auto;
  font-size:11px; color:var(--muted);
  padding:4px 8px; border:1px solid var(--line); border-radius:999px;
  background: rgba(255,255,255,.04);
}
.sidebar-foot{
  margin-top:auto;
  padding:12px 14px;
  border-top:1px solid var(--line);
  color:var(--muted);
  font-size:12px;
}

.main{ padding:16px; max-width:1100px; margin:0 auto; }
.card{
  background: rgba(17,26,45,.86);
  border:1px solid var(--line);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}
.card.pad{ padding:14px; }
.grid{
  display:grid; gap:12px;
}
.grid.cols2{ grid-template-columns: 1fr; }
.grid.cols3{ grid-template-columns: 1fr; }
@media (min-width: 820px){
  .grid.cols2{ grid-template-columns: 1fr 1fr; }
  .grid.cols3{ grid-template-columns: 1fr 1fr 1fr; }
}

.h1{ font-size:22px; font-weight:900; margin:0 0 10px; }
.h2{ font-size:16px; font-weight:900; margin:0 0 10px; color:var(--text); }
.muted{ color:var(--muted); }

.row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.spacer{ flex:1; }

.table{
  width:100%;
  border-collapse: collapse;
  overflow:hidden;
  border-radius:14px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.02);
}
.table th, .table td{
  padding:10px;
  border-bottom:1px solid var(--line);
  font-size:13px;
}
.table th{ text-align:right; color:var(--muted); font-weight:800; }
.table tr:last-child td{ border-bottom:none; }
.table .num{ text-align:left; font-variant-numeric: tabular-nums; }
.table .actions{ white-space:nowrap; text-align:left; }

.field{
  display:flex; flex-direction:column; gap:6px;
}
.label{ color:var(--muted); font-size:12px; }
.input, select, textarea{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.05);
  color: var(--text);
  outline:none;
}
textarea{ min-height:90px; resize:vertical; }

.kpis{ display:grid; gap:12px; grid-template-columns: 1fr; }
@media(min-width:820px){ .kpis{ grid-template-columns: repeat(4, 1fr); } }
.kpi{
  background: rgba(255,255,255,.04);
  border:1px solid var(--line);
  border-radius: var(--radius2);
  padding:12px;
}
.kpi .t{ color:var(--muted); font-size:12px; }
.kpi .v{ font-size:20px; font-weight:900; margin-top:4px; font-variant-numeric:tabular-nums; }

.toast{
  position: fixed;
  left: 16px;
  bottom: 16px;
  z-index: 100;
  padding: 12px 14px;
  border-radius: 14px;
  border: 1px solid var(--line);
  background: rgba(17,26,45,.92);
  backdrop-filter: blur(8px);
  box-shadow: var(--shadow);
  color: var(--text);
  display:none;
  max-width:min(520px, 90vw);
}
.toast.show{ display:block; }

.hr{ height:1px; background:var(--line); margin:10px 0; }

.badge{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px; border-radius:999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.04);
  color:var(--muted);
  font-size:12px;
}
.badge.ok{ color: var(--ok); border-color: rgba(61,220,151,.30); }
.badge.warn{ color: var(--warn); border-color: rgba(255,211,110,.30); }
.badge.danger{ color: var(--danger); border-color: rgba(255,92,122,.30); }

/* Print */
@media print{
  body{ background:#fff; color:#000; }
  .topbar,.sidebar,.toast,.no-print{ display:none !important; }
  .main{ padding:0; max-width:unset; margin:0; }
  .card{ box-shadow:none; border:none; border-radius:0; background:#fff; }
}

  </style>
</head>
<body>
  <div id="app">
    <header class="topbar">
      <button class="iconbtn" id="btnMenu" aria-label="القائمة">☰</button>
      <div class="brand">
        <div class="brand-title">Jood kids seals</div>
        <div class="brand-sub">نظام المبيعات — GitHub + Firebase</div>
      </div>
      <div class="topbar-right">
        <div class="chip" id="chipUser">غير مسجل</div>
        <button class="btn ghost" id="btnLogout" style="display:none">تسجيل خروج</button>
      </div>
    </header>

    <aside class="sidebar" id="sidebar" aria-label="القائمة">
      <div class="sidebar-head">
        <div class="sidebar-title">القائمة</div>
        <button class="iconbtn" id="btnCloseMenu" aria-label="إغلاق">✕</button>
      </div>
      <nav class="nav" id="nav"></nav>
      <div class="sidebar-foot">
        <div class="muted">نسخة: <span id="ver">2026.02.19-PRO</span></div>
      </div>
    </aside>

    <main class="main">
      <div class="toast" id="toast" role="status" aria-live="polite"></div>
      <div id="view"></div>
    </main>
  </div>

  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import {
  getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc,
  query, where, orderBy, limit, getDocs, serverTimestamp, runTransaction, Timestamp
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";


/* ===================== Bundled App (Single File) =====================
   Generated: 2026-02-19T03:07:08
   Version: 2026.02.19-PRO
   Notes:
   - No folders needed.
   - Uses Firebase Auth + Firestore + Storage.
====================================================================== */

// Firebase init (v10 modular)
const firebaseConfig = {
  "apiKey": "AIzaSyCe2W80FgybECOwF-55fUBZhxzTOYjpcUQ",
  "authDomain": "seals-jood.firebaseapp.com",
  "projectId": "seals-jood",
  "storageBucket": "seals-jood.firebasestorage.app",
  "messagingSenderId": "835360944508",
  "appId": "1:835360944508:web:dec8cf1d16830553d334f9"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

function fmtMoney(n){
  const v = Number(n||0);
  return v.toLocaleString('ar-EG', {minimumFractionDigits:2, maximumFractionDigits:2});
}
function fmtDate(ts){
  const d = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : new Date(ts||Date.now()));
  return d.toLocaleDateString('ar-EG');
}
function fmtDateTime(ts){
  const d = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : new Date(ts||Date.now()));
  return d.toLocaleString('ar-EG');
}
function uid(){
  return Math.random().toString(16).slice(2)+Date.now().toString(16);
}
function toast(msg, kind=''){
  const el = document.getElementById('toast');
  if(!el) return;
  el.classList.add('show');
  el.textContent = msg;
  clearTimeout(window.__toastT);
  window.__toastT = setTimeout(()=> el.classList.remove('show'), 2600);
}
function escapeHtml(s=''){
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#039;');
}
function clamp(n,min,max){ return Math.min(max, Math.max(min,n)); }
function parseDiscount(value, type){
  const v = Number(value||0);
  if(type === 'percent') return clamp(v,0,100);
  return Math.max(0,v);
}
function calcLine(qty, price, discType, discVal){
  qty = Number(qty||0); price = Number(price||0);
  const gross = qty * price;
  let disc = 0;
  if(discType === 'percent') disc = gross * (Number(discVal||0)/100);
  else disc = Number(discVal||0);
  disc = clamp(disc,0,gross);
  const net = gross - disc;
  return {gross, disc, net};
}
function amountToArabicWordsEGP(amount){
  // Lightweight Arabic words (approx). Not a full linguistic engine.
  // Good enough for invoices.
  const num = Number(amount||0);
  const pounds = Math.floor(num);
  const piasters = Math.round((num - pounds)*100);

  function toWords(n){
    const ones = ['صفر','واحد','اثنان','ثلاثة','أربعة','خمسة','ستة','سبعة','ثمانية','تسعة'];
    const tens = ['','عشرة','عشرون','ثلاثون','أربعون','خمسون','ستون','سبعون','ثمانون','تسعون'];
    const teens = ['عشرة','أحد عشر','اثنا عشر','ثلاثة عشر','أربعة عشر','خمسة عشر','ستة عشر','سبعة عشر','ثمانية عشر','تسعة عشر'];
    const hundreds = ['','مائة','مائتان','ثلاثمائة','أربعمائة','خمسمائة','ستمائة','سبعمائة','ثمانمائة','تسعمائة'];

    if(n < 10) return ones[n];
    if(n < 20) return teens[n-10];
    if(n < 100){
      const o = n % 10, t = Math.floor(n/10);
      return o ? `${ones[o]} و ${tens[t]}` : tens[t];
    }
    if(n < 1000){
      const r = n % 100, h = Math.floor(n/100);
      return r ? `${hundreds[h]} و ${toWords(r)}` : hundreds[h];
    }
    if(n < 1_000_000){
      const r = n % 1000, th = Math.floor(n/1000);
      const thWord = th===1 ? 'ألف' : (th===2 ? 'ألفان' : `${toWords(th)} ألف`);
      return r ? `${thWord} و ${toWords(r)}` : thWord;
    }
    const r = n % 1_000_000, m = Math.floor(n/1_000_000);
    const mWord = m===1 ? 'مليون' : (m===2 ? 'مليونان' : `${toWords(m)} مليون`);
    return r ? `${mWord} و ${toWords(r)}` : mWord;
  }

  const p = toWords(pounds);
  const pi = piasters ? toWords(piasters) : 'صفر';
  return `${p} جنيه مصري و ${pi} قرش فقط لا غير`;
}

const PERMS = {
  invoices_view: 'عرض الفواتير',
  invoices_create: 'إنشاء فواتير',
  invoices_print: 'طباعة فواتير',
  returns_view: 'عرض المرتجعات',
  returns_create: 'إنشاء مرتجع',
  payments_view: 'عرض الدفعات',
  payments_create: 'إنشاء دفعات',
  payments_print: 'طباعة سند قبض',
  customers_view: 'عرض العملاء',
  customers_manage: 'إدارة العملاء',
  products_view: 'عرض الأصناف',
  products_manage: 'إدارة الأصناف',
  reports_view: 'عرض التقارير',
  reports_export: 'تصدير التقارير',
  audit_view: 'عرض سجل العمليات',
  users_manage: 'إدارة المستخدمين',
  company_manage: 'بيانات الشركة'
};
function hasPerm(me, key){
  if(!me) return false;
  if(me.role === 'admin') return true;
  return !!(me.permissions && me.permissions[key]);
}

async function logAudit(me, action, meta={}){
  try{
    await addDoc(collection(db,'auditLogs'),{
      action,
      byUid: me?.uid || null,
      byName: me?.displayName || me?.email || 'unknown',
      at: serverTimestamp(),
      meta
    });
  }catch(e){
    // silent
    console.warn('audit failed', e);
  }
}

function watchAuth(cb){
  return onAuthStateChanged(auth, async (user)=>{
    if(!user){ cb(null, null); return; }
    const ref = doc(db,'users', user.uid);
    const snap = await getDoc(ref);
    const profile = snap.exists() ? snap.data() : null;
    cb(user, profile ? ({uid:user.uid, email:user.email, ...profile}) : ({uid:user.uid, email:user.email, role:'user', active:false}));
  });
}
async function login(email, password){
  return signInWithEmailAndPassword(auth, email, password);
}
async function logout(){
  return signOut(auth);
}

function need(me, perm){
  if(!hasPerm(me, perm)){
    return `<div class="card pad"><div class="h1">صلاحية غير كافية</div>
      <div class="muted">لا تملك صلاحية: <b>${escapeHtml(PERMS[perm]||perm)}</b></div></div>`;
  }
  return null;
}
async function viewLogin(){
  return `<div class="card pad" style="max-width:520px;margin:24px auto;">
    <div class="h1">تسجيل الدخول</div>
    <div class="muted">ادخل البريد وكلمة المرور (Firebase Auth)</div>
    <div class="hr"></div>
    <form id="formLogin" class="grid" autocomplete="on">
      <div class="field">
        <div class="label">البريد الإلكتروني</div>
        <input class="input" name="email" type="email" required placeholder="example@mail.com" />
      </div>
      <div class="field">
        <div class="label">كلمة المرور</div>
        <input class="input" name="password" type="password" required placeholder="••••••••" />
      </div>
      <div class="row">
        <button class="btn" type="submit">دخول</button>
        <div class="muted">إن لم يفتح: تأكد أن المستخدم Active داخل قاعدة users.</div>
      </div>
    </form>
  </div>`;
}

async function getCompany(){
  const snap = await getDoc(doc(db,'settings','company'));
  return snap.exists()? snap.data(): {name:'Jood kids seals', phones:[], address:'', whatsapp:'', telegram:'', facebook:'', footerNote:'', logoUrl:''};
}
async function viewDashboard(me){
  const deny = need(me,'reports_view');
  // dashboard is like reports_view
  if(deny) return deny;

  // KPIs from last 30 days
  const start = Timestamp.fromDate(new Date(Date.now() - 30*24*3600*1000));
  const qInv = query(collection(db,'invoices'), where('date','>=', start), orderBy('date','desc'), limit(200));
  const snaps = await getDocs(qInv);
  let sales=0, returns=0, count=0;
  snaps.forEach(s=>{
    const d=s.data();
    count++;
    if(d.docType==='return') returns += Number(d.grandTotal||0);
    else sales += Number(d.grandTotal||0);
  });
  const net = sales - returns;

  return `<div class="grid">
    <div class="card pad">
      <div class="h1">الرئيسية</div>
      <div class="muted">ملخص آخر 30 يوم (مبيعات/مرتجعات)</div>
      <div class="hr"></div>
      <div class="kpis">
        <div class="kpi"><div class="t">إجمالي المبيعات</div><div class="v">${fmtMoney(sales)} ج</div></div>
        <div class="kpi"><div class="t">إجمالي المرتجعات</div><div class="v">${fmtMoney(returns)} ج</div></div>
        <div class="kpi"><div class="t">صافي المبيعات</div><div class="v">${fmtMoney(net)} ج</div></div>
        <div class="kpi"><div class="t">عدد المستندات</div><div class="v">${count}</div></div>
      </div>
    </div>

    <div class="card pad">
      <div class="row">
        <div>
          <div class="h2">اختصارات</div>
          <div class="muted">افتح سريعًا أهم الشاشات</div>
        </div>
        <div class="spacer"></div>
        <a class="btn small" href="#/invoices/new">فاتورة جديدة</a>
        <a class="btn small ghost" href="#/returns/new">مرتجع جديد</a>
      </div>
    </div>
  </div>`;
}

async function listCustomersOptions(){
  const qy = query(collection(db,'customers'), orderBy('name','asc'), limit(500));
  const snaps = await getDocs(qy);
  const opts = ['<option value="">— اختر —</option>'];
  snaps.forEach(s=>{
    const d=s.data();
    opts.push(`<option value="${s.id}">${escapeHtml(d.name||'')}</option>`);
  });
  return opts.join('');
}
async function listProductsOptions(){
  const qy = query(collection(db,'products'), orderBy('name','asc'), limit(1000));
  const snaps = await getDocs(qy);
  const list = [];
  snaps.forEach(s=>{
    const d=s.data();
    if(d.active===false) return;
    list.push({id:s.id, name:d.name, code:d.code||'', price:Number(d.price||0)});
  });
  return list;
}

function invoiceTableRow(i, prodList){
  const p = prodList.find(x=>x.id===i.productId) || null;
  const code = i.codeSnapshot ?? (p?.code||'');
  const name = i.nameSnapshot ?? (p?.name||'');
  const price = i.priceSnapshot ?? (p?.price||0);
  const qty = i.qty ?? 1;
  const discType = i.discountTypeItem ?? 'amount';
  const discVal = i.discountValueItem ?? 0;
  const {gross, disc, net} = calcLine(qty, price, discType, discVal);
  const total = net;
  return {code,name,price,qty,discType,discVal,total,gross,disc};
}

function renderInvoiceEditor(me, docType, model, customersOptions, products){
  // model = existing invoice or draft
  const isAdmin = me.role === 'admin';
  const canEdit = isAdmin; // per requirement
  const isNew = !model?.id;

  const items = model?.items || [];
  const payType = model?.payType || 'cash';
  const customerId = model?.customerId || '';
  const date = model?.date ? fmtDate(model.date) : fmtDate(new Date());
  const discountTypeInvoice = model?.discountTypeInvoice || 'amount';
  const discountValueInvoice = model?.discountValueInvoice ?? 0;
  const paid = model?.paid ?? (payType==='cash' ? (model?.grandTotal||0) : 0);

  return `<div class="card pad">
    <div class="row">
      <div>
        <div class="h1">${docType==='sale'?'فاتورة مبيعات':'مرتجع مبيعات'}</div>
        <div class="muted">${isNew?'إنشاء مستند جديد':'عرض/تعديل (الأدمن فقط)'}</div>
      </div>
      <div class="spacer"></div>
      <a class="btn ghost small no-print" href="#/${docType==='sale'?'invoices':'returns'}">رجوع</a>
      ${!isNew ? `<span class="badge ${model.locked?'ok':'warn'}">${model.locked?'مقفلة':'غير مقفلة'}</span>`:''}
    </div>

    <div class="hr"></div>

    <form id="formInv" class="grid cols2">
      <div class="field">
        <div class="label">التاريخ</div>
        <input class="input" name="date" type="date" value="${escapeHtml(new Date(model?.date?.toDate?model.date.toDate():model?.date||Date.now()).toISOString().slice(0,10))}" ${(!isNew && !canEdit)?'disabled':''}/>
      </div>

      <div class="field">
        <div class="label">نوع الفاتورة</div>
        <select name="payType" ${(!isNew && !canEdit)?'disabled':''}>
          <option value="cash" ${payType==='cash'?'selected':''}>نقدي</option>
          <option value="credit" ${payType==='credit'?'selected':''}>أجل</option>
        </select>
      </div>

      <div class="field">
        <div class="label">العميل</div>
        <select name="customerId" ${(!isNew && !canEdit)?'disabled':''}>${customersOptions}</select>
        <div class="muted">ملاحظة: لا يوجد “عميل نقدي” افتراضي — اختر عميلًا أو اتركه فارغًا.</div>
      </div>

      <div class="field">
        <div class="label">ملاحظة</div>
        <input class="input" name="note" value="${escapeHtml(model?.note||'')}" ${(!isNew && !canEdit)?'disabled':''} placeholder="اختياري"/>
      </div>

      <div class="card pad" style="grid-column:1/-1;">
        <div class="row no-print">
          <div class="h2">بنود الفاتورة</div>
          <div class="spacer"></div>
          <button type="button" class="btn small" id="btnAddLine" ${(!isNew && !canEdit)?'disabled':''}>إضافة بند</button>
        </div>
        <div class="hr"></div>
        <div style="overflow:auto;">
          <table class="table" id="tblLines">
            <thead>
              <tr>
                <th>رمز</th>
                <th>الصنف</th>
                <th class="num">الكمية</th>
                <th>الوحدة</th>
                <th class="num">السعر</th>
                <th class="num">خصم الصنف</th>
                <th class="num">الإجمالي</th>
                <th class="actions no-print">إجراءات</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="muted" style="margin-top:8px;">الوحدة ثابتة: <b>قطعة</b>. الخصم احترافي: على الصنف وعلى الفاتورة.</div>
      </div>

      <div class="card pad" style="grid-column:1/-1;">
        <div class="grid cols3">
          <div class="field">
            <div class="label">خصم الفاتورة</div>
            <div class="row">
              <select name="discountTypeInvoice" style="max-width:140px" ${(!isNew && !canEdit)?'disabled':''}>
                <option value="amount" ${discountTypeInvoice==='amount'?'selected':''}>مبلغ</option>
                <option value="percent" ${discountTypeInvoice==='percent'?'selected':''}>٪</option>
              </select>
              <input class="input" name="discountValueInvoice" type="number" step="0.01" value="${escapeHtml(discountValueInvoice)}" ${(!isNew && !canEdit)?'disabled':''}/>
            </div>
          </div>

          <div class="field">
            <div class="label">المدفوع</div>
            <input class="input" name="paid" type="number" step="0.01" value="${escapeHtml(paid)}" ${(!isNew && !canEdit)?'disabled':''}/>
            <div class="muted">نقدي: المدفوع = الإجمالي (افتراضي). أجل: يمكن دفع جزء.</div>
          </div>

          <div class="field">
            <div class="label">المبلغ بالحروف</div>
            <div class="input" id="moneyWords" style="min-height:48px; display:flex; align-items:center;"></div>
          </div>
        </div>

        <div class="hr"></div>
        <div class="row">
          <div class="badge" id="bSubtotal">المجموع: 0.00</div>
          <div class="badge" id="bDiscItems">خصم الأصناف: 0.00</div>
          <div class="badge" id="bDiscInv">خصم الفاتورة: 0.00</div>
          <div class="badge ok" id="bGrand">الإجمالي: 0.00</div>
          <div class="badge" id="bRemaining">المتبقي: 0.00</div>
          <div class="spacer"></div>
          ${isNew ? `<button class="btn ok no-print" type="submit">حفظ</button>` : (canEdit ? `<button class="btn ok no-print" type="submit">حفظ التعديل</button>` : '')}
          ${!isNew ? `<button class="btn ghost no-print" type="button" id="btnPrintA4">طباعة A4</button>
                       <button class="btn ghost no-print" type="button" id="btnPrintTh">طباعة حراري</button>` : ''}
          ${(!isNew && me.role==='admin') ? `<button class="btn danger no-print" type="button" id="btnDelete">حذف</button>`:''}
        </div>
      </div>
    </form>
  </div>`;
}

function buildLineEditorRow(idx, item, products, disabled){
  const prod = products.find(p=>p.id===item.productId) || null;
  const productOptions = ['<option value="">— اختر صنف —</option>'].concat(
    products.map(p=>`<option value="${p.id}" ${(item.productId===p.id)?'selected':''}>${escapeHtml(p.name)} — ${fmtMoney(p.price)} ج</option>`)
  ).join('');
  const qty = item.qty ?? 1;
  const price = item.priceSnapshot ?? (prod?.price||0);
  const discType = item.discountTypeItem ?? 'amount';
  const discVal = item.discountValueItem ?? 0;

  return `<tr data-idx="${idx}">
    <td class="muted">${escapeHtml(item.codeSnapshot||prod?.code||'')}</td>
    <td>
      <select data-f="productId" ${disabled?'disabled':''}>${productOptions}</select>
      <div class="muted" style="font-size:11px;margin-top:4px;">Snapshot: الاسم/السعر يُحفظ داخل الفاتورة</div>
    </td>
    <td class="num"><input class="input" style="padding:8px" type="number" min="0" step="1" data-f="qty" value="${escapeHtml(qty)}" ${disabled?'disabled':''}></td>
    <td>قطعة</td>
    <td class="num"><input class="input" style="padding:8px" type="number" step="0.01" data-f="priceSnapshot" value="${escapeHtml(price)}" ${disabled?'disabled':''}></td>
    <td class="num">
      <div class="row" style="justify-content:flex-start">
        <select data-f="discountTypeItem" style="max-width:96px" ${disabled?'disabled':''}>
          <option value="amount" ${discType==='amount'?'selected':''}>مبلغ</option>
          <option value="percent" ${discType==='percent'?'selected':''}>٪</option>
        </select>
        <input class="input" style="padding:8px;max-width:140px" type="number" step="0.01" data-f="discountValueItem" value="${escapeHtml(discVal)}" ${disabled?'disabled':''}>
      </div>
    </td>
    <td class="num" data-calc="total">0.00</td>
    <td class="actions no-print">
      <button class="btn small danger" type="button" data-act="del" ${disabled?'disabled':''}>حذف بند</button>
    </td>
  </tr>`;
}

function computeInvoiceFromForm(form, products){
  const data = new FormData(form);
  const dateStr = data.get('date');
  const date = Timestamp.fromDate(new Date(dateStr+'T12:00:00'));
  const payType = data.get('payType') || 'cash';
  const customerId = data.get('customerId') || '';
  const note = (data.get('note')||'').toString().trim();
  const discountTypeInvoice = data.get('discountTypeInvoice') || 'amount';
  const discountValueInvoice = parseDiscount(data.get('discountValueInvoice'), discountTypeInvoice);
  const paid = Number(data.get('paid')||0);

  // lines from table
  const rows = Array.from(document.querySelectorAll('#tblLines tbody tr'));
  const items = rows.map(r=>{
    const idx = r.getAttribute('data-idx');
    const get = (f)=> r.querySelector(`[data-f="${f}"]`)?.value;
    const productId = get('productId') || '';
    const prod = products.find(p=>p.id===productId) || {};
    const nameSnapshot = prod.name || '';
    const codeSnapshot = prod.code || '';
    const qty = Number(get('qty')||0);
    const priceSnapshot = Number(get('priceSnapshot')||0);
    const discountTypeItem = get('discountTypeItem') || 'amount';
    const discountValueItem = parseDiscount(get('discountValueItem'), discountTypeItem);
    const {gross, disc, net} = calcLine(qty, priceSnapshot, discountTypeItem, discountValueItem);
    return {
      productId,
      codeSnapshot,
      nameSnapshot,
      qty,
      unit:'قطعة',
      priceSnapshot,
      discountTypeItem,
      discountValueItem,
      lineGross: gross,
      lineDiscount: disc,
      lineTotal: net
    };
  }).filter(x=>x.productId && x.qty>0);

  // totals
  const subtotal = items.reduce((a,x)=>a+Number(x.lineGross||0),0);
  const discItems = items.reduce((a,x)=>a+Number(x.lineDiscount||0),0);
  const afterItems = items.reduce((a,x)=>a+Number(x.lineTotal||0),0);

  let discInv = 0;
  if(discountTypeInvoice==='percent') discInv = afterItems*(discountValueInvoice/100);
  else discInv = discountValueInvoice;
  discInv = clamp(discInv,0,afterItems);
  const grandTotal = afterItems - discInv;

  let paidTotal = paid;
  if(payType==='cash') paidTotal = grandTotal; // default enforce on cash (user can still edit if admin)
  paidTotal = clamp(paidTotal,0,grandTotal);
  const remaining = grandTotal - paidTotal;

  return {
    date, payType, customerId, note,
    items,
    subtotal,
    discountTypeInvoice,
    discountValueInvoice,
    discountItemsTotal: discItems,
    discountInvoiceTotal: discInv,
    grandTotal,
    paid: paidTotal,
    remaining
  };
}

function clamp(n,min,max){ return Math.min(max, Math.max(min,n)); }

function renderInvoicePrint(company, inv, kind='a4'){
  // kind a4 / th
  const logo = company.logoUrl ? `<img src="${escapeHtml(company.logoUrl)}" style="max-height:${kind==='a4'?'70px':'50px'};object-fit:contain" />` : '';
  const phones = (company.phones||[]).map(p=>escapeHtml(p)).join(' — ');
  const header = kind==='a4' ? `
    <div style="display:flex;gap:14px;align-items:center;justify-content:space-between;">
      <div style="min-width:0">
        <div style="font-size:20px;font-weight:900">${escapeHtml(company.name||'')}</div>
        <div style="font-size:12px;color:#333;margin-top:4px">${escapeHtml(company.address||'')}</div>
        <div style="font-size:12px;color:#333;margin-top:4px">${phones}</div>
      </div>
      <div>${logo}</div>
    </div>
    <hr/>
  ` : `
    <div style="text-align:center;">
      <div style="font-weight:900;font-size:18px">${escapeHtml(company.name||'')}</div>
      ${logo?`<div style="margin-top:6px">${logo}</div>`:''}
      <div style="font-size:12px;margin-top:6px">${phones}</div>
      <div style="font-size:12px">${escapeHtml(company.address||'')}</div>
    </div>
    <hr/>
  `;

  const title = inv.docType==='return' ? 'مرتجع مبيعات' : 'فاتورة مبيعات';
  const pay = inv.payType==='credit' ? 'أجل' : 'نقدي';
  const cust = inv.customerNameSnapshot || '—';
  const date = fmtDate(inv.date);

  const rows = inv.items.map((x,i)=>`
    <tr>
      <td>${escapeHtml(x.codeSnapshot||'')}</td>
      <td>${escapeHtml(x.nameSnapshot||'')}</td>
      <td style="text-align:left">${Number(x.qty||0)}</td>
      <td>قطعة</td>
      <td style="text-align:left">${fmtMoney(x.priceSnapshot||0)}</td>
      <td style="text-align:left">${fmtMoney(x.lineTotal||0)}</td>
    </tr>
  `).join('');

  const totals = `
    <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;">
      <div>المجموع: <b>${fmtMoney(inv.subtotal||0)}</b> ج</div>
      <div>خصم الأصناف: <b>${fmtMoney(inv.discountItemsTotal||0)}</b> ج</div>
      <div>خصم الفاتورة: <b>${fmtMoney(inv.discountInvoiceTotal||0)}</b> ج</div>
      <div>الإجمالي: <b>${fmtMoney(inv.grandTotal||0)}</b> ج</div>
      <div>المدفوع: <b>${fmtMoney(inv.paid||0)}</b> ج</div>
      <div>المتبقي: <b>${fmtMoney(inv.remaining||0)}</b> ج</div>
    </div>
  `;

  const words = amountToArabicWordsEGP(inv.grandTotal||0);

  const footer = company.footerNote ? `<hr/><div style="font-size:12px;color:#333">${escapeHtml(company.footerNote)}</div>`:'';

  const pageStyle = kind==='th' ? `
    <style>
      @page { size: 80mm auto; margin: 6mm; }
      body { font-family: Arial, "Noto Kufi Arabic", "Noto Sans Arabic", sans-serif; direction: rtl; }
      table { width:100%; border-collapse:collapse; font-size:12px; }
      th,td { padding:6px 0; border-bottom:1px dashed #999; text-align:right; }
      th{ font-weight:800; }
      .meta{ font-size:12px; }
    </style>
  ` : `
    <style>
      @page { size: A4; margin: 12mm; }
      body { font-family: Arial, "Noto Kufi Arabic", "Noto Sans Arabic", sans-serif; direction: rtl; }
      table { width:100%; border-collapse:collapse; font-size:12px; }
      th,td { padding:8px; border:1px solid #ddd; text-align:right; }
      th{ background:#f5f7ff; font-weight:800; }
      .meta{ font-size:12px; color:#333; }
    </style>
  `;

  return `<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8">${pageStyle}</head>
  <body>
    ${header}
    <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;" class="meta">
      <div><b>${title}</b></div>
      <div>رقم: <b>${inv.invoiceNo}</b></div>
      <div>تاريخ: <b>${date}</b></div>
    </div>
    <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:8px" class="meta">
      <div>العميل: <b>${escapeHtml(cust)}</b></div>
      <div>النوع: <b>${pay}</b></div>
    </div>
    <hr/>
    <table>
      <thead>
        <tr>
          <th>رمز</th><th>المادة</th><th style="text-align:left">الكمية</th><th>الوحدة</th>
          <th style="text-align:left">السعر</th><th style="text-align:left">القيمة</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
    <hr/>
    ${totals}
    <hr/>
    <div style="font-size:12px;color:#333">المبلغ بالحروف: <b>${escapeHtml(words)}</b></div>
    ${footer}
    <script>window.onload=()=>window.print();</script>
  </body></html>`;
}
async function viewInvoices(me, mode='sale'){
  const perm = mode==='sale' ? 'invoices_view' : 'returns_view';
  const deny = need(me, perm);
  if(deny) return deny;

  const docType = mode==='sale' ? 'sale' : 'return';
  const qy = query(collection(db,'invoices'), where('docType','==', docType), orderBy('date','desc'), limit(200));
  const snaps = await getDocs(qy);

  const rows = [];
  snaps.forEach(s=>{
    const d=s.data();
    rows.push(`<tr>
      <td class="num">${d.invoiceNo ?? ''}</td>
      <td>${escapeHtml(d.customerNameSnapshot||'—')}</td>
      <td>${fmtDate(d.date)}</td>
      <td class="num">${fmtMoney(d.grandTotal||0)}</td>
      <td>${d.payType==='credit' ? '<span class="badge warn">أجل</span>' : '<span class="badge ok">نقدي</span>'}</td>
      <td>${d.locked ? '<span class="badge ok">مقفلة</span>' : '<span class="badge warn">غير مقفلة</span>'}</td>
      <td class="actions">
        <a class="btn small ghost" href="#/${mode}/${s.id}">فتح</a>
      </td>
    </tr>`);
  });

  const canCreate = hasPerm(me, mode==='sale'?'invoices_create':'returns_create');

  return `<div class="card pad">
    <div class="row">
      <div>
        <div class="h1">${mode==='sale'?'فواتير المبيعات':'مرتجعات المبيعات'}</div>
        <div class="muted">بحث سريع: اكتب رقم فاتورة أو اسم عميل داخل المتصفح (Ctrl+F)</div>
      </div>
      <div class="spacer"></div>
      ${canCreate?`<a class="btn no-print" href="#/${mode}/new">${mode==='sale'?'فاتورة جديدة':'مرتجع جديد'}</a>`:''}
    </div>
    <div class="hr"></div>
    <div style="overflow:auto;">
      <table class="table">
        <thead>
          <tr>
            <th class="num">رقم</th>
            <th>العميل</th>
            <th>التاريخ</th>
            <th class="num">الإجمالي</th>
            <th>النوع</th>
            <th>القفل</th>
            <th class="actions">إجراءات</th>
          </tr>
        </thead>
        <tbody>${rows.join('') || `<tr><td colspan="7" class="muted">لا توجد بيانات بعد.</td></tr>`}</tbody>
      </table>
    </div>
  </div>`;
}
async function viewInvoiceEditor(me, mode, id){
  const permView = mode==='sale' ? 'invoices_view' : 'returns_view';
  const permCreate = mode==='sale' ? 'invoices_create' : 'returns_create';
  if(!hasPerm(me, permView)) return need(me, permView);

  const docType = mode==='sale' ? 'sale' : 'return';
  const customersOptions = await listCustomersOptions();
  const products = await listProductsOptions();

  if(id==='new'){
    if(!hasPerm(me, permCreate)) return need(me, permCreate);
    const html = renderInvoiceEditor(me, docType, {docType, locked:false, items:[]}, customersOptions, products);
    return html;
  }

  const snap = await getDoc(doc(db,'invoices', id));
  if(!snap.exists()) return `<div class="card pad"><div class="h1">غير موجود</div></div>`;
  const inv = {id:snap.id, ...snap.data()};
  const html = renderInvoiceEditor(me, docType, inv, customersOptions, products);
  return html;
}
async function bindInvoiceEditor(me, mode, id){
  // called after view rendered
  const form = document.getElementById('formInv');
  if(!form) return;

  // set selected customer on new (options already built)
  if(id==='new'){
    form.customerId.value = '';
  }else{
    const snap = await getDoc(doc(db,'invoices', id));
    if(snap.exists()){
      const inv = snap.data();
      form.customerId.value = inv.customerId || '';
    }
  }

  const products = await listProductsOptions();

  // lines state
  let state = {items:[]};
  if(id!=='new'){
    const snap = await getDoc(doc(db,'invoices', id));
    if(snap.exists()) state = {items: (snap.data().items||[])};
  }

  const isAdmin = me.role === 'admin';
  const disabled = (id!=='new' && !isAdmin); // edits only admin
  const tbody = document.querySelector('#tblLines tbody');

  function rerenderLines(){
    tbody.innerHTML = state.items.map((it,idx)=>buildLineEditorRow(idx, it, products, disabled)).join('');
    tbody.querySelectorAll('button[data-act="del"]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const tr = btn.closest('tr');
        const idx = Number(tr.getAttribute('data-idx'));
        state.items.splice(idx,1);
        rerenderLines(); recalcTotals();
      });
    });
    tbody.querySelectorAll('select,input').forEach(el=>{
      el.addEventListener('input', ()=>{
        const tr = el.closest('tr');
        const idx = Number(tr.getAttribute('data-idx'));
        const f = el.getAttribute('data-f');
        state.items[idx][f] = el.value;
        // when product changes, set snapshots
        if(f==='productId'){
          const prod = products.find(p=>p.id===el.value);
          state.items[idx].nameSnapshot = prod?.name || '';
          state.items[idx].codeSnapshot = prod?.code || '';
          state.items[idx].priceSnapshot = prod?.price || 0;
          rerenderLines();
        }else{
          recalcTotals();
        }
      });
    });
    recalcTotals();
  }

  function recalcTotals(){
    // compute per row totals
    let subtotal=0, discItems=0, afterItems=0;
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      const idx = Number(tr.getAttribute('data-idx'));
      const item = state.items[idx];
      const prod = products.find(p=>p.id===item.productId) || {};
      const qty = Number(item.qty||tr.querySelector('[data-f="qty"]')?.value||0);
      const price = Number(item.priceSnapshot||tr.querySelector('[data-f="priceSnapshot"]')?.value||prod.price||0);
      const discType = item.discountTypeItem || tr.querySelector('[data-f="discountTypeItem"]')?.value || 'amount';
      const discVal = Number(item.discountValueItem||tr.querySelector('[data-f="discountValueItem"]')?.value||0);
      const {gross,disc,net} = calcLine(qty, price, discType, discVal);
      subtotal += gross;
      discItems += disc;
      afterItems += net;
      tr.querySelector('[data-calc="total"]').textContent = fmtMoney(net);
    });

    const dt = form.discountTypeInvoice.value;
    const dv = Number(form.discountValueInvoice.value||0);
    let discInv = (dt==='percent') ? afterItems*(dv/100) : dv;
    discInv = clamp(discInv,0,afterItems);
    const grand = afterItems - discInv;

    const payType = form.payType.value;
    let paid = Number(form.paid.value||0);
    if(payType==='cash') paid = grand;
    paid = clamp(paid,0,grand);
    const remaining = grand - paid;

    document.getElementById('bSubtotal').textContent = `المجموع: ${fmtMoney(subtotal)} ج`;
    document.getElementById('bDiscItems').textContent = `خصم الأصناف: ${fmtMoney(discItems)} ج`;
    document.getElementById('bDiscInv').textContent = `خصم الفاتورة: ${fmtMoney(discInv)} ج`;
    document.getElementById('bGrand').textContent = `الإجمالي: ${fmtMoney(grand)} ج`;
    document.getElementById('bRemaining').textContent = `المتبقي: ${fmtMoney(remaining)} ج`;
    document.getElementById('moneyWords').textContent = amountToArabicWordsEGP(grand);
    // update paid field enforce cash
    if(payType==='cash') form.paid.value = grand.toFixed(2);
  }

  document.getElementById('btnAddLine')?.addEventListener('click', ()=>{
    state.items.push({productId:'', qty:1, unit:'قطعة', priceSnapshot:0, discountTypeItem:'amount', discountValueItem:0});
    rerenderLines();
  });

  form.discountTypeInvoice?.addEventListener('input', recalcTotals);
  form.discountValueInvoice?.addEventListener('input', recalcTotals);
  form.payType?.addEventListener('input', recalcTotals);
  form.paid?.addEventListener('input', recalcTotals);

  // initialize at least one line
  if(state.items.length===0){
    state.items.push({productId:'', qty:1, unit:'قطعة', priceSnapshot:0, discountTypeItem:'amount', discountValueItem:0});
  }
  rerenderLines();

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(id!=='new' && me.role!=='admin'){ toast('التعديل متاح للأدمن فقط'); return; }

    // customer snapshot
    const customerId = form.customerId.value || '';
    let customerNameSnapshot = '';
    if(customerId){
      const cs = await getDoc(doc(db,'customers', customerId));
      if(cs.exists()) customerNameSnapshot = cs.data().name || '';
    }

    const computed = computeInvoiceFromForm(form, products);
    computed.docType = (mode==='sale'?'sale':'return');
    computed.customerNameSnapshot = customerNameSnapshot || '—';

    // return should be negative effect? We'll store as positive grandTotal but docType marks return.
    // For simplicity, keep totals positive and treat return as separate in reports.

    if(computed.items.length===0){ toast('أضف بنوداً صحيحة'); return; }

    if(id==='new'){
      // transaction for invoiceNo counter
      const newId = await runTransaction(db, async (tx)=>{
        const cRef = doc(db,'counters','invoices');
        const cSnap = await tx.get(cRef);
        let next = 1;
        if(cSnap.exists()) next = Number(cSnap.data().next||1);
        tx.set(cRef, {next: next+1}, {merge:true});
        const invRef = doc(collection(db,'invoices'));
        tx.set(invRef, {
          invoiceNo: next,
          ...computed,
          locked: true,
          createdByUid: me.uid,
          createdByName: me.displayName || me.email || 'user',
          createdAt: serverTimestamp()
        });
        return invRef.id;
      });

      await logAudit(me, 'CREATE_INVOICE', {docType:computed.docType, invoiceId:newId});
      toast('تم الحفظ');
      location.hash = `#/${mode}/${newId}`;
      return;
    }else{
      const invRef = doc(db,'invoices', id);
      await updateDoc(invRef, {
        ...computed,
        locked: true,
        updatedAt: serverTimestamp(),
        updatedByUid: me.uid,
        updatedByName: me.displayName || me.email || 'admin'
      });
      await logAudit(me, 'UPDATE_INVOICE', {docType:computed.docType, invoiceId:id});
      toast('تم حفظ التعديل');
    }
  });

  if(id!=='new'){
    const btnA4 = document.getElementById('btnPrintA4');
    const btnTh = document.getElementById('btnPrintTh');
    async function doPrint(kind){
      const invSnap = await getDoc(doc(db,'invoices', id));
      if(!invSnap.exists()) return;
      const inv = {id:invSnap.id, ...invSnap.data()};
      const company = await getCompany();
      const html = renderInvoicePrint(company, inv, kind);
      const w = window.open('', '_blank');
      w.document.open(); w.document.write(html); w.document.close();
      // lock already true; still log print
      await logAudit(me, kind==='a4'?'PRINT_INVOICE_A4':'PRINT_INVOICE_TH', {invoiceId:id, invoiceNo:inv.invoiceNo});
    }
    btnA4?.addEventListener('click', ()=>doPrint('a4'));
    btnTh?.addEventListener('click', ()=>doPrint('th'));

    document.getElementById('btnDelete')?.addEventListener('click', async ()=>{
      if(me.role!=='admin'){ toast('الحذف للأدمن فقط'); return; }
      const invSnap = await getDoc(doc(db,'invoices', id));
      if(!invSnap.exists()) return;
      const inv = invSnap.data();
      if(!confirm(`تأكيد حذف المستند رقم ${inv.invoiceNo}?`)) return;
      await deleteDoc(doc(db,'invoices', id));
      await logAudit(me, 'DELETE_INVOICE', {invoiceId:id, invoiceNo:inv.invoiceNo, docType:inv.docType, total:inv.grandTotal});
      toast('تم الحذف');
      location.hash = `#/${mode}`;
    });
  }
}
async function viewCustomers(me){
  const deny = need(me,'customers_view');
  if(deny) return deny;

  const canManage = hasPerm(me,'customers_manage');

  const qy = query(collection(db,'customers'), orderBy('name','asc'), limit(500));
  const snaps = await getDocs(qy);

  const rows = [];
  snaps.forEach(s=>{
    const d=s.data();
    rows.push(`<tr>
      <td>${escapeHtml(d.name||'')}</td>
      <td>${escapeHtml(d.phone||'')}</td>
      <td>${escapeHtml(d.address||'')}</td>
      <td class="actions">
        ${canManage?`<button class="btn small ghost" data-act="edit" data-id="${s.id}">تعديل</button>`:''}
        ${me.role==='admin'?`<button class="btn small danger" data-act="del" data-id="${s.id}">حذف</button>`:''}
      </td>
    </tr>`);
  });

  return `<div class="card pad">
    <div class="row">
      <div>
        <div class="h1">العملاء</div>
        <div class="muted">بدون رصيد افتتاحي — الرصيد يُحسب من الحركات</div>
      </div>
      <div class="spacer"></div>
      ${canManage?`<button class="btn no-print" id="btnNewCust">عميل جديد</button>`:''}
    </div>
    <div class="hr"></div>
    <div id="custFormWrap" class="card pad" style="display:none; background:rgba(255,255,255,.03);"></div>
    <div style="overflow:auto;">
      <table class="table">
        <thead><tr><th>الاسم</th><th>الهاتف</th><th>العنوان</th><th class="actions">إجراءات</th></tr></thead>
        <tbody>${rows.join('') || `<tr><td colspan="4" class="muted">لا توجد بيانات.</td></tr>`}</tbody>
      </table>
    </div>
  </div>`;
}
async function bindCustomers(me){
  const canManage = hasPerm(me,'customers_manage');
  const wrap = document.getElementById('custFormWrap');
  const btnNew = document.getElementById('btnNewCust');
  if(btnNew && canManage){
    btnNew.addEventListener('click', ()=>showForm());
  }
  function showForm(model=null){
    wrap.style.display='block';
    wrap.innerHTML = `<div class="row">
      <div class="h2">${model?'تعديل عميل':'عميل جديد'}</div>
      <div class="spacer"></div>
      <button class="btn small ghost" id="btnCloseCust">إغلاق</button>
    </div>
    <div class="hr"></div>
    <form id="formCust" class="grid cols2">
      <div class="field"><div class="label">اسم العميل</div><input class="input" name="name" required value="${escapeHtml(model?.name||'')}"></div>
      <div class="field"><div class="label">الهاتف</div><input class="input" name="phone" value="${escapeHtml(model?.phone||'')}"></div>
      <div class="field" style="grid-column:1/-1;"><div class="label">العنوان</div><input class="input" name="address" value="${escapeHtml(model?.address||'')}"></div>
      <div class="row" style="grid-column:1/-1;">
        <button class="btn ok" type="submit">حفظ</button>
        ${model?`<span class="muted">ID: ${escapeHtml(model.id)}</span>`:''}
      </div>
    </form>`;
    document.getElementById('btnCloseCust').onclick=()=>{ wrap.style.display='none'; wrap.innerHTML=''; };
    document.getElementById('formCust').onsubmit = async (e)=>{
      e.preventDefault();
      const fd=new FormData(e.target);
      const data={name:fd.get('name').toString().trim(), phone:(fd.get('phone')||'').toString().trim(), address:(fd.get('address')||'').toString().trim(), updatedAt:serverTimestamp()};
      if(!data.name){ toast('الاسم مطلوب'); return; }
      if(model){
        await updateDoc(doc(db,'customers', model.id), data);
        await logAudit(me,'UPDATE_CUSTOMER',{customerId:model.id, name:data.name});
      }else{
        const r = await addDoc(collection(db,'customers'), {...data, createdAt:serverTimestamp()});
        await logAudit(me,'CREATE_CUSTOMER',{customerId:r.id, name:data.name});
      }
      toast('تم الحفظ'); location.hash='#/customers';
    };
  }

  document.querySelectorAll('button[data-act="edit"]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id=btn.getAttribute('data-id');
      const s=await getDoc(doc(db,'customers',id));
      if(!s.exists()) return;
      showForm({id, ...s.data()});
    });
  });
  document.querySelectorAll('button[data-act="del"]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      if(me.role!=='admin'){ toast('الحذف للأدمن فقط'); return; }
      const id=btn.getAttribute('data-id');
      // prevent delete if referenced
      const qy = query(collection(db,'invoices'), where('customerId','==',id), limit(1));
      const hits = await getDocs(qy);
      if(!hits.empty){ toast('لا يمكن حذف عميل عليه فواتير'); return; }
      if(!confirm('تأكيد حذف العميل؟')) return;
      await deleteDoc(doc(db,'customers',id));
      await logAudit(me,'DELETE_CUSTOMER',{customerId:id});
      toast('تم الحذف'); location.hash='#/customers';
    });
  });
}
async function viewProducts(me){
  const deny = need(me,'products_view');
  if(deny) return deny;
  const canManage = hasPerm(me,'products_manage');

  const qy = query(collection(db,'products'), orderBy('name','asc'), limit(1000));
  const snaps = await getDocs(qy);

  const rows = [];
  snaps.forEach(s=>{
    const d=s.data();
    rows.push(`<tr>
      <td>${escapeHtml(d.code||'')}</td>
      <td>${escapeHtml(d.name||'')}</td>
      <td class="num">${fmtMoney(d.price||0)}</td>
      <td>${d.active===false?'<span class="badge danger">موقوف</span>':'<span class="badge ok">نشط</span>'}</td>
      <td class="actions">
        ${canManage?`<button class="btn small ghost" data-act="edit" data-id="${s.id}">تعديل</button>`:''}
        ${me.role==='admin'?`<button class="btn small danger" data-act="del" data-id="${s.id}">حذف</button>`:''}
      </td>
    </tr>`);
  });

  return `<div class="card pad">
    <div class="row">
      <div>
        <div class="h1">الأصناف (قائمة أسعار)</div>
        <div class="muted">بدون مخزون — فقط رمز/اسم/سعر</div>
      </div>
      <div class="spacer"></div>
      ${canManage?`<button class="btn no-print" id="btnNewProd">صنف جديد</button>`:''}
    </div>
    <div class="hr"></div>
    <div id="prodFormWrap" class="card pad" style="display:none; background:rgba(255,255,255,.03);"></div>
    <div style="overflow:auto;">
      <table class="table">
        <thead><tr><th>الرمز</th><th>الاسم</th><th class="num">السعر</th><th>الحالة</th><th class="actions">إجراءات</th></tr></thead>
        <tbody>${rows.join('') || `<tr><td colspan="5" class="muted">لا توجد بيانات.</td></tr>`}</tbody>
      </table>
    </div>
  </div>`;
}
async function bindProducts(me){
  const canManage = hasPerm(me,'products_manage');
  const wrap = document.getElementById('prodFormWrap');
  const btnNew = document.getElementById('btnNewProd');
  if(btnNew && canManage){
    btnNew.addEventListener('click', ()=>showForm());
  }
  function showForm(model=null){
    wrap.style.display='block';
    wrap.innerHTML = `<div class="row">
      <div class="h2">${model?'تعديل صنف':'صنف جديد'}</div>
      <div class="spacer"></div>
      <button class="btn small ghost" id="btnCloseProd">إغلاق</button>
    </div>
    <div class="hr"></div>
    <form id="formProd" class="grid cols2">
      <div class="field"><div class="label">رمز الصنف</div><input class="input" name="code" value="${escapeHtml(model?.code||'')}" placeholder="اختياري"></div>
      <div class="field"><div class="label">اسم الصنف</div><input class="input" name="name" required value="${escapeHtml(model?.name||'')}"></div>
      <div class="field"><div class="label">السعر (جنيه)</div><input class="input" name="price" type="number" step="0.01" required value="${escapeHtml(model?.price??0)}"></div>
      <div class="field"><div class="label">الحالة</div>
        <select name="active">
          <option value="true" ${(model?.active===false)?'':'selected'}>نشط</option>
          <option value="false" ${(model?.active===false)?'selected':''}>موقوف</option>
        </select>
      </div>
      <div class="row" style="grid-column:1/-1;">
        <button class="btn ok" type="submit">حفظ</button>
      </div>
    </form>`;
    document.getElementById('btnCloseProd').onclick=()=>{ wrap.style.display='none'; wrap.innerHTML=''; };
    document.getElementById('formProd').onsubmit = async (e)=>{
      e.preventDefault();
      const fd=new FormData(e.target);
      const data={
        code:(fd.get('code')||'').toString().trim(),
        name:fd.get('name').toString().trim(),
        price:Number(fd.get('price')||0),
        active: fd.get('active')==='true',
        updatedAt:serverTimestamp()
      };
      if(!data.name){ toast('الاسم مطلوب'); return; }
      if(model){
        await updateDoc(doc(db,'products', model.id), data);
        await logAudit(me,'UPDATE_PRODUCT',{productId:model.id, name:data.name});
      }else{
        const r = await addDoc(collection(db,'products'), {...data, createdAt:serverTimestamp()});
        await logAudit(me,'CREATE_PRODUCT',{productId:r.id, name:data.name});
      }
      toast('تم الحفظ'); location.hash='#/products';
    };
  }

  document.querySelectorAll('button[data-act="edit"]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id=btn.getAttribute('data-id');
      const s=await getDoc(doc(db,'products',id));
      if(!s.exists()) return;
      showForm({id, ...s.data()});
    });
  });
  document.querySelectorAll('button[data-act="del"]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      if(me.role!=='admin'){ toast('الحذف للأدمن فقط'); return; }
      const id=btn.getAttribute('data-id');
      // prevent delete if referenced in invoices
      const qy = query(collection(db,'invoices'), where('items','!=',null), limit(1)); // can't query array of objects; so soft check omitted
      if(!confirm('تأكيد حذف الصنف؟ (إن كان مستخدمًا في فواتير سابقة لن تتأثر الفواتير بسبب Snapshot)')) return;
      await deleteDoc(doc(db,'products',id));
      await logAudit(me,'DELETE_PRODUCT',{productId:id});
      toast('تم الحذف'); location.hash='#/products';
    });
  });
}
async function viewPayments(me){
  const deny = need(me,'payments_view');
  if(deny) return deny;

  const canCreate = hasPerm(me,'payments_create');

  const qy = query(collection(db,'payments'), orderBy('date','desc'), limit(200));
  const snaps = await getDocs(qy);

  const rows = [];
  snaps.forEach(s=>{
    const d=s.data();
    rows.push(`<tr>
      <td>${escapeHtml(d.customerNameSnapshot||'—')}</td>
      <td>${fmtDate(d.date)}</td>
      <td class="num">${fmtMoney(d.amount||0)}</td>
      <td>${escapeHtml(d.method||'')}</td>
      <td>${d.invoiceNo ? `فاتورة #${d.invoiceNo}` : 'على الحساب'}</td>
      <td class="actions">
        ${hasPerm(me,'payments_print')?`<button class="btn small ghost" data-act="print" data-id="${s.id}">طباعة</button>`:''}
        ${me.role==='admin'?`<button class="btn small danger" data-act="del" data-id="${s.id}">حذف</button>`:''}
      </td>
    </tr>`);
  });

  const customersOptions = await listCustomersOptions();

  return `<div class="card pad">
    <div class="row">
      <div>
        <div class="h1">الدفعات</div>
        <div class="muted">تشمل دفعة على الحساب + دفعة مرتبطة بفاتورة</div>
      </div>
      <div class="spacer"></div>
      ${canCreate?`<button class="btn no-print" id="btnNewPay">دفعة جديدة</button>`:''}
    </div>
    <div class="hr"></div>
    <div id="payFormWrap" class="card pad" style="display:none; background:rgba(255,255,255,.03);"></div>

    <div style="overflow:auto;">
      <table class="table">
        <thead><tr><th>العميل</th><th>التاريخ</th><th class="num">المبلغ</th><th>الطريقة</th><th>النوع</th><th class="actions">إجراءات</th></tr></thead>
        <tbody>${rows.join('') || `<tr><td colspan="6" class="muted">لا توجد بيانات.</td></tr>`}</tbody>
      </table>
    </div>

    <div class="muted" style="margin-top:10px;">طرق الدفع الافتراضية: نقداً / تحويل / فودافون كاش (يمكن تعديلها لاحقًا).</div>
  </div>`;
}

function renderPaymentPrint(company, pay, kind='a4'){
  const phones = (company.phones||[]).join(' — ');
  const logo = company.logoUrl ? `<img src="${escapeHtml(company.logoUrl)}" style="max-height:${kind==='a4'?'70px':'50px'};object-fit:contain" />` : '';
  const pageStyle = kind==='th' ? `
    <style>
      @page { size: 80mm auto; margin: 6mm; }
      body { font-family: Arial, "Noto Kufi Arabic", "Noto Sans Arabic", sans-serif; direction: rtl; }
      .t{font-weight:900;font-size:16px;text-align:center}
      .k{font-size:12px}
    </style>
  ` : `
    <style>
      @page { size: A4; margin: 12mm; }
      body { font-family: Arial, "Noto Kufi Arabic", "Noto Sans Arabic", sans-serif; direction: rtl; }
      .wrap{border:1px solid #ddd;padding:12px;border-radius:10px}
      .t{font-weight:900;font-size:18px}
      .k{font-size:12px;color:#333}
    </style>
  `;
  return `<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8">${pageStyle}</head>
  <body>
    ${kind==='a4'?`<div class="wrap">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div>
          <div class="t">${escapeHtml(company.name||'')}</div>
          <div class="k">${escapeHtml(company.address||'')}</div>
          <div class="k">${escapeHtml(phones||'')}</div>
        </div>
        <div>${logo}</div>
      </div>
      <hr/>
      <div class="t" style="text-align:center">سند قبض</div>
      <div class="k">التاريخ: <b>${fmtDate(pay.date)}</b></div>
      <div class="k">العميل: <b>${escapeHtml(pay.customerNameSnapshot||'—')}</b></div>
      <div class="k">المبلغ: <b>${fmtMoney(pay.amount||0)}</b> جنيه</div>
      <div class="k">الطريقة: <b>${escapeHtml(pay.method||'')}</b></div>
      <div class="k">البيان: <b>${pay.invoiceNo?`دفعة لفاتورة رقم ${pay.invoiceNo}`:'دفعة على الحساب'}</b></div>
      ${company.footerNote?`<hr/><div class="k">${escapeHtml(company.footerNote)}</div>`:''}
    </div>`:
    `<div style="text-align:center">
      <div class="t">${escapeHtml(company.name||'')}</div>
      ${logo?`<div style="margin-top:6px">${logo}</div>`:''}
      <div class="k">${escapeHtml(phones||'')}</div>
      <hr/>
      <div class="t">سند قبض</div>
      <div class="k">تاريخ: <b>${fmtDate(pay.date)}</b></div>
      <div class="k">عميل: <b>${escapeHtml(pay.customerNameSnapshot||'—')}</b></div>
      <div class="k">مبلغ: <b>${fmtMoney(pay.amount||0)}</b></div>
      <div class="k">طريقة: <b>${escapeHtml(pay.method||'')}</b></div>
      <div class="k">${pay.invoiceNo?`فاتورة #${pay.invoiceNo}`:'على الحساب'}</div>
      ${company.footerNote?`<hr/><div class="k">${escapeHtml(company.footerNote)}</div>`:''}
    </div>`}
    <script>window.onload=()=>window.print();</script>
  </body></html>`;
}
async function bindPayments(me){
  const canCreate = hasPerm(me,'payments_create');
  const wrap = document.getElementById('payFormWrap');
  const btnNew = document.getElementById('btnNewPay');

  const customersOptions = await listCustomersOptions();

  if(btnNew && canCreate){
    btnNew.addEventListener('click', ()=>showForm());
  }

  function showForm(model=null){
    wrap.style.display='block';
    wrap.innerHTML = `<div class="row">
      <div class="h2">${model?'تعديل دفعة':'دفعة جديدة'}</div>
      <div class="spacer"></div>
      <button class="btn small ghost" id="btnClosePay">إغلاق</button>
    </div>
    <div class="hr"></div>
    <form id="formPay" class="grid cols2">
      <div class="field">
        <div class="label">التاريخ</div>
        <input class="input" name="date" type="date" value="${new Date().toISOString().slice(0,10)}" />
      </div>
      <div class="field">
        <div class="label">العميل</div>
        <select name="customerId" required>${customersOptions}</select>
      </div>
      <div class="field">
        <div class="label">المبلغ</div>
        <input class="input" name="amount" type="number" step="0.01" required />
      </div>
      <div class="field">
        <div class="label">طريقة الدفع</div>
        <select name="method">
          <option value="نقداً">نقداً</option>
          <option value="تحويل">تحويل</option>
          <option value="فودافون كاش">فودافون كاش</option>
        </select>
      </div>
      <div class="field" style="grid-column:1/-1;">
        <div class="label">ربط بفاتورة (اختياري)</div>
        <input class="input" name="invoiceNo" type="number" step="1" placeholder="اكتب رقم الفاتورة أو اتركه فارغًا لدفعة على الحساب" />
      </div>
      <div class="field" style="grid-column:1/-1;">
        <div class="label">ملاحظة</div>
        <input class="input" name="note" placeholder="اختياري" />
      </div>
      <div class="row" style="grid-column:1/-1;">
        <button class="btn ok" type="submit">حفظ</button>
      </div>
    </form>`;
    document.getElementById('btnClosePay').onclick=()=>{ wrap.style.display='none'; wrap.innerHTML=''; };
    document.getElementById('formPay').onsubmit = async (e)=>{
      e.preventDefault();
      const fd=new FormData(e.target);
      const customerId = fd.get('customerId')?.toString()||'';
      const amount = Number(fd.get('amount')||0);
      const method = (fd.get('method')||'').toString();
      const invoiceNo = Number(fd.get('invoiceNo')||0) || null;
      const note = (fd.get('note')||'').toString().trim();
      const date = Timestamp.fromDate(new Date(fd.get('date')+'T12:00:00'));

      if(!customerId){ toast('اختر عميل'); return; }
      if(amount<=0){ toast('المبلغ غير صحيح'); return; }

      // snapshot customer name
      const cs = await getDoc(doc(db,'customers', customerId));
      const customerNameSnapshot = cs.exists()? (cs.data().name||'') : '—';

      // optional invoice link by invoiceNo
      let invoiceId = null;
      let linkedInvoiceNo = null;
      if(invoiceNo){
        const qy = query(collection(db,'invoices'), where('invoiceNo','==', invoiceNo), limit(1));
        const hits = await getDocs(qy);
        if(hits.empty){ toast('لم يتم العثور على رقم الفاتورة'); return; }
        invoiceId = hits.docs[0].id;
        linkedInvoiceNo = invoiceNo;
        // update invoice paid/remaining (admin only or allowed perm?)
        // Requirement doesn't restrict; but safe: allow payments_create.
        const invRef = doc(db,'invoices', invoiceId);
        await runTransaction(db, async (tx)=>{
          const s=await tx.get(invRef);
          if(!s.exists()) throw new Error('invoice missing');
          const inv=s.data();
          const grand=Number(inv.grandTotal||0);
          const paidOld=Number(inv.paid||0);
          const paidNew = clamp(paidOld + amount, 0, grand);
          const remNew = grand - paidNew;
          tx.update(invRef, {paid: paidNew, remaining: remNew, updatedAt: serverTimestamp()});
        });
      }

      const r = await addDoc(collection(db,'payments'),{
        customerId,
        customerNameSnapshot,
        amount,
        method,
        note,
        date,
        invoiceId,
        invoiceNo: linkedInvoiceNo,
        onAccount: !invoiceId,
        createdByUid: me.uid,
        createdByName: me.displayName || me.email || 'user',
        createdAt: serverTimestamp()
      });
      await logAudit(me,'CREATE_PAYMENT',{paymentId:r.id, amount, customerId, invoiceNo: linkedInvoiceNo});
      toast('تم الحفظ'); location.hash='#/payments';
    };
  }

  // print / delete actions
  document.querySelectorAll('button[data-act="print"]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      if(!hasPerm(me,'payments_print')){ toast('لا تملك صلاحية الطباعة'); return; }
      const id=btn.getAttribute('data-id');
      const s=await getDoc(doc(db,'payments',id));
      if(!s.exists()) return;
      const company=await getCompany();
      const pay={id, ...s.data()};
      // choose kind
      const kind = confirm('طباعة حراري؟ (OK=حراري, Cancel=A4)') ? 'th' : 'a4';
      const html = renderPaymentPrint(company, pay, kind);
      const w = window.open('', '_blank');
      w.document.open(); w.document.write(html); w.document.close();
      await logAudit(me, kind==='th'?'PRINT_RECEIPT_TH':'PRINT_RECEIPT_A4', {paymentId:id});
    });
  });

  document.querySelectorAll('button[data-act="del"]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      if(me.role!=='admin'){ toast('الحذف للأدمن فقط'); return; }
      const id=btn.getAttribute('data-id');
      const s=await getDoc(doc(db,'payments',id));
      if(!s.exists()) return;
      const pay=s.data();
      if(!confirm('تأكيد حذف الدفعة؟')) return;

      // If linked invoice, rollback paid (best effort)
      if(pay.invoiceId){
        const invRef = doc(db,'invoices', pay.invoiceId);
        await runTransaction(db, async (tx)=>{
          const invS=await tx.get(invRef);
          if(invS.exists()){
            const inv=invS.data();
            const grand=Number(inv.grandTotal||0);
            const paidOld=Number(inv.paid||0);
            const paidNew = clamp(paidOld - Number(pay.amount||0), 0, grand);
            tx.update(invRef, {paid: paidNew, remaining: grand - paidNew, updatedAt: serverTimestamp()});
          }
        });
      }

      await deleteDoc(doc(db,'payments',id));
      await logAudit(me,'DELETE_PAYMENT',{paymentId:id, amount:pay.amount, invoiceNo:pay.invoiceNo||null});
      toast('تم الحذف'); location.hash='#/payments';
    });
  });
}
async function viewCompany(me){
  const deny = need(me,'company_manage');
  if(deny) return deny;

  const company = await getCompany();
  const phones = (company.phones||[]).join('\n');

  return `<div class="card pad">
    <div class="row">
      <div>
        <div class="h1">بيانات الشركة</div>
        <div class="muted">تعديل ورفع لوجو — للأدمن فقط</div>
      </div>
      <div class="spacer"></div>
      <span class="badge ok">Admin</span>
    </div>
    <div class="hr"></div>

    <form id="formCompany" class="grid cols2">
      <div class="field">
        <div class="label">اسم الشركة</div>
        <input class="input" name="name" value="${escapeHtml(company.name||'')}" required>
      </div>
      <div class="field">
        <div class="label">العنوان</div>
        <input class="input" name="address" value="${escapeHtml(company.address||'')}">
      </div>
      <div class="field" style="grid-column:1/-1;">
        <div class="label">أرقام التواصل (كل رقم بسطر)</div>
        <textarea name="phones">${escapeHtml(phones)}</textarea>
      </div>
      <div class="field">
        <div class="label">واتساب</div>
        <input class="input" name="whatsapp" value="${escapeHtml(company.whatsapp||'')}">
      </div>
      <div class="field">
        <div class="label">تليجرام</div>
        <input class="input" name="telegram" value="${escapeHtml(company.telegram||'')}">
      </div>
      <div class="field" style="grid-column:1/-1;">
        <div class="label">فيسبوك</div>
        <input class="input" name="facebook" value="${escapeHtml(company.facebook||'')}">
      </div>
      <div class="field" style="grid-column:1/-1;">
        <div class="label">ملاحظة أسفل الفاتورة</div>
        <textarea name="footerNote" placeholder="مثال: شكراً لتعاملكم معنا">${escapeHtml(company.footerNote||'')}</textarea>
      </div>

      <div class="card pad" style="grid-column:1/-1; background:rgba(255,255,255,.03);">
        <div class="row">
          <div>
            <div class="h2">اللوجو</div>
            <div class="muted">رفع صورة شعار (PNG/JPG). سيتم حفظها في Firebase Storage</div>
          </div>
          <div class="spacer"></div>
          ${company.logoUrl?`<a class="btn small ghost" href="${escapeHtml(company.logoUrl)}" target="_blank">عرض</a>`:''}
        </div>
        <div class="hr"></div>
        <div class="row">
          <input class="input" type="file" id="fileLogo" accept="image/*" style="max-width:420px;">
          <button class="btn small ok" type="button" id="btnUploadLogo">رفع/تحديث</button>
          ${company.logoUrl?`<button class="btn small danger" type="button" id="btnDeleteLogo">حذف اللوجو</button>`:''}
        </div>
      </div>

      <div class="row" style="grid-column:1/-1;">
        <button class="btn ok" type="submit">حفظ البيانات</button>
      </div>
    </form>
  </div>`;
}
async function bindCompany(me){
  const form = document.getElementById('formCompany');
  if(!form) return;
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(form);
    const phones = (fd.get('phones')||'').toString().split('\n').map(s=>s.trim()).filter(Boolean);
    const data = {
      name: fd.get('name').toString().trim(),
      address: (fd.get('address')||'').toString().trim(),
      phones,
      whatsapp: (fd.get('whatsapp')||'').toString().trim(),
      telegram: (fd.get('telegram')||'').toString().trim(),
      facebook: (fd.get('facebook')||'').toString().trim(),
      footerNote: (fd.get('footerNote')||'').toString().trim(),
      updatedAt: serverTimestamp(),
      updatedBy: me.uid
    };
    await setDoc(doc(db,'settings','company'), data, {merge:true});
    await logAudit(me,'UPDATE_COMPANY', {});
    toast('تم حفظ بيانات الشركة');
  });

  const btnUpload = document.getElementById('btnUploadLogo');
  btnUpload?.addEventListener('click', async ()=>{
    const inp = document.getElementById('fileLogo');
    const file = inp?.files?.[0];
    if(!file){ toast('اختر صورة أولاً'); return; }
    const path = `company/logo.png`;
    const r = sRef(storage, path);
    await uploadBytes(r, file, {contentType: file.type});
    const url = await getDownloadURL(r);
    await setDoc(doc(db,'settings','company'), {logoUrl:url, updatedAt: serverTimestamp(), updatedBy: me.uid}, {merge:true});
    await logAudit(me,'UPLOAD_LOGO', {path});
    toast('تم رفع اللوجو');
    location.hash = '#/company';
  });

  const btnDel = document.getElementById('btnDeleteLogo');
  btnDel?.addEventListener('click', async ()=>{
    if(!confirm('تأكيد حذف اللوجو؟')) return;
    const path = `company/logo.png`;
    try{ await deleteObject(sRef(storage, path)); }catch(e){}
    await setDoc(doc(db,'settings','company'), {logoUrl:'', updatedAt: serverTimestamp(), updatedBy: me.uid}, {merge:true});
    await logAudit(me,'DELETE_LOGO', {path});
    toast('تم حذف اللوجو');
    location.hash = '#/company';
  });
}
async function viewUsers(me){
  const deny = need(me,'users_manage');
  if(deny) return deny;

  const qy = query(collection(db,'users'), orderBy('displayName','asc'), limit(200));
  const snaps = await getDocs(qy);
  const rows = [];
  snaps.forEach(s=>{
    const d=s.data();
    rows.push(`<tr>
      <td>${escapeHtml(d.displayName||'')}</td>
      <td>${escapeHtml(d.role||'user')}</td>
      <td>${d.active?'<span class="badge ok">مفعل</span>':'<span class="badge danger">موقوف</span>'}</td>
      <td class="actions"><button class="btn small ghost" data-act="edit" data-id="${s.id}">تعديل</button></td>
    </tr>`);
  });

  return `<div class="card pad">
    <div class="h1">المستخدمون والصلاحيات</div>
    <div class="muted">ملاحظة: إنشاء حساب (Email/Password) يتم من Firebase Auth. هنا نحدد Active/Permissions.</div>
    <div class="hr"></div>
    <div class="card pad" style="background:rgba(255,255,255,.03);">
      <div class="h2">إضافة مستخدم جديد (خطوتين)</div>
      <ol class="muted" style="margin:0; padding-inline-start:18px;">
        <li>أنشئ المستخدم من Firebase Authentication (Email/Password).</li>
        <li>انسخ UID من قائمة Users داخل Auth ثم اضغط “مستخدم جديد” وألصقه لتفعيل الصلاحيات.</li>
      </ol>
      <div class="hr"></div>
      <button class="btn no-print" id="btnNewUser">مستخدم جديد</button>
    </div>

    <div class="hr"></div>
    <div id="userFormWrap" class="card pad" style="display:none; background:rgba(255,255,255,.03);"></div>

    <div style="overflow:auto;">
      <table class="table">
        <thead><tr><th>الاسم</th><th>الدور</th><th>الحالة</th><th class="actions">إجراءات</th></tr></thead>
        <tbody>${rows.join('') || `<tr><td colspan="4" class="muted">لا توجد بيانات.</td></tr>`}</tbody>
      </table>
    </div>
  </div>`;
}
async function bindUsers(me){
  const wrap = document.getElementById('userFormWrap');
  const btnNew = document.getElementById('btnNewUser');
  btnNew?.addEventListener('click', ()=>showForm(null, true));

  function permChecks(selected){
    return Object.entries(PERMS).map(([k, label])=>{
      const checked = selected?.[k] ? 'checked' : '';
      return `<label class="row" style="justify-content:space-between; margin:6px 0; gap:12px;">
        <span>${escapeHtml(label)}</span>
        <input type="checkbox" name="perm_${k}" ${checked} />
      </label>`;
    }).join('');
  }

  async function showForm(userId, isNew=false){
    let model = null;
    if(userId){
      const s=await getDoc(doc(db,'users', userId));
      if(s.exists()) model = {id:userId, ...s.data()};
    }
    wrap.style.display='block';
    wrap.innerHTML = `<div class="row">
      <div class="h2">${isNew?'مستخدم جديد':'تعديل مستخدم'}</div>
      <div class="spacer"></div>
      <button class="btn small ghost" id="btnCloseUser">إغلاق</button>
    </div>
    <div class="hr"></div>
    <form id="formUser" class="grid cols2">
      <div class="field">
        <div class="label">UID</div>
        <input class="input" name="uid" ${isNew?'':'disabled'} value="${escapeHtml(model?.id||'')}" placeholder="الصقه من Firebase Auth" required>
      </div>
      <div class="field">
        <div class="label">الاسم المعروض</div>
        <input class="input" name="displayName" value="${escapeHtml(model?.displayName||'')}" required>
      </div>
      <div class="field">
        <div class="label">الدور</div>
        <select name="role">
          <option value="user" ${(model?.role==='admin')?'':'selected'}>user</option>
          <option value="admin" ${(model?.role==='admin')?'selected':''}>admin</option>
        </select>
      </div>
      <div class="field">
        <div class="label">الحالة</div>
        <select name="active">
          <option value="true" ${(model?.active===false)?'':'selected'}>مفعل</option>
          <option value="false" ${(model?.active===false)?'selected':''}>موقوف</option>
        </select>
      </div>

      <div class="card pad" style="grid-column:1/-1; background:rgba(255,255,255,.03);">
        <div class="h2">الصلاحيات (Checkbox)</div>
        <div class="muted">الأدمن يمتلك كل الصلاحيات تلقائياً.</div>
        <div class="hr"></div>
        <div class="grid cols2">${permChecks(model?.permissions||{})}</div>
      </div>

      <div class="row" style="grid-column:1/-1;">
        <button class="btn ok" type="submit">حفظ</button>
      </div>
    </form>`;
    document.getElementById('btnCloseUser').onclick=()=>{ wrap.style.display='none'; wrap.innerHTML=''; };

    document.getElementById('formUser').onsubmit = async (e)=>{
      e.preventDefault();
      const fd=new FormData(e.target);
      const uid = fd.get('uid')?.toString().trim();
      const displayName = fd.get('displayName')?.toString().trim();
      const role = fd.get('role')?.toString()||'user';
      const active = fd.get('active')==='true';

      const permissions = {};
      Object.keys(PERMS).forEach(k=>{
        permissions[k] = fd.get(`perm_${k}`) === 'on';
      });

      if(!uid || !displayName){ toast('البيانات ناقصة'); return; }
      await setDoc(doc(db,'users', uid), {
        displayName, role, active, permissions,
        updatedAt: serverTimestamp(), updatedBy: me.uid
      }, {merge:true});
      await logAudit(me, isNew?'CREATE_USER':'UPDATE_USER', {uid, role, active});
      toast('تم الحفظ'); location.hash='#/users';
    };
  }

  document.querySelectorAll('button[data-act="edit"]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id=btn.getAttribute('data-id');
      showForm(id,false);
    });
  });
}
async function viewAudit(me){
  const deny = need(me,'audit_view');
  if(deny) return deny;

  const qy = query(collection(db,'auditLogs'), orderBy('at','desc'), limit(200));
  const snaps = await getDocs(qy);

  const rows = [];
  snaps.forEach(s=>{
    const d=s.data();
    rows.push(`<tr>
      <td>${fmtDateTime(d.at)}</td>
      <td>${escapeHtml(d.byName||'')}</td>
      <td>${escapeHtml(d.action||'')}</td>
      <td class="muted">${escapeHtml(JSON.stringify(d.meta||{}))}</td>
    </tr>`);
  });

  return `<div class="card pad">
    <div class="h1">سجل العمليات</div>
    <div class="muted">آخر 200 عملية</div>
    <div class="hr"></div>
    <div style="overflow:auto;">
      <table class="table">
        <thead><tr><th>الوقت</th><th>المستخدم</th><th>العملية</th><th>تفاصيل</th></tr></thead>
        <tbody>${rows.join('') || `<tr><td colspan="4" class="muted">لا توجد بيانات.</td></tr>`}</tbody>
      </table>
    </div>
  </div>`;
}
async function viewReports(me){
  const deny = need(me,'reports_view');
  if(deny) return deny;

  return `<div class="card pad">
    <div class="h1">التقارير</div>
    <div class="muted">نسخة أولى: تقارير أساسية (قيد التوسعة)</div>
    <div class="hr"></div>
    <div class="grid cols2">
      <div class="card pad" style="background:rgba(255,255,255,.03);">
        <div class="h2">تقرير مبيعات بين تاريخين</div>
        <form id="formRepSales" class="grid">
          <div class="field"><div class="label">من</div><input class="input" type="date" name="from" required></div>
          <div class="field"><div class="label">إلى</div><input class="input" type="date" name="to" required></div>
          <div class="row"><button class="btn ok" type="submit">عرض</button>
            ${hasPerm(me,'reports_export')?`<button class="btn ghost" type="button" id="btnExportCSV" disabled>تصدير CSV</button>`:''}
          </div>
        </form>
        <div class="hr"></div>
        <div id="repOut" class="muted">—</div>
      </div>

      <div class="card pad" style="background:rgba(255,255,255,.03);">
        <div class="h2">أرصدة العملاء (حساب تلقائي)</div>
        <div class="muted">يحسب من الفواتير والدفعات (بدون رصيد افتتاحي)</div>
        <div class="hr"></div>
        <button class="btn ok" id="btnCustBalances">حساب الأرصدة</button>
        <div class="hr"></div>
        <div id="repBal" class="muted">—</div>
      </div>
    </div>
  </div>`;
}
async function bindReports(me){
  const form = document.getElementById('formRepSales');
  const out = document.getElementById('repOut');
  const btnCSV = document.getElementById('btnExportCSV');
  let lastRows = [];

  form?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd=new FormData(form);
    const from = new Date(fd.get('from')+'T00:00:00');
    const to = new Date(fd.get('to')+'T23:59:59');
    const fromTs = Timestamp.fromDate(from);
    const toTs = Timestamp.fromDate(to);

    const qy = query(collection(db,'invoices'), where('date','>=', fromTs), where('date','<=', toTs), orderBy('date','desc'), limit(1000));
    const snaps = await getDocs(qy);
    let sales=0, returns=0;
    lastRows = [];
    snaps.forEach(s=>{
      const d=s.data();
      if(d.docType==='return') returns += Number(d.grandTotal||0);
      else sales += Number(d.grandTotal||0);
      lastRows.push({invoiceNo:d.invoiceNo, date: fmtDate(d.date), customer:d.customerNameSnapshot||'', docType:d.docType, total:d.grandTotal});
    });
    const net = sales - returns;
    out.textContent = `مبيعات: ${fmtMoney(sales)} ج — مرتجعات: ${fmtMoney(returns)} ج — صافي: ${fmtMoney(net)} ج — عدد: ${lastRows.length}`;

    if(btnCSV){
      btnCSV.disabled = !(lastRows.length>0);
    }
  });

  btnCSV?.addEventListener('click', ()=>{
    if(!hasPerm(me,'reports_export')) return;
    const header = ['invoiceNo','date','customer','docType','total'];
    const csv = [header.join(',')].concat(
      lastRows.map(r=>header.map(k=>String(r[k]??'').replaceAll(',',' ')).join(','))
    ).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `sales_report_${Date.now()}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  document.getElementById('btnCustBalances')?.addEventListener('click', async ()=>{
    const repBal = document.getElementById('repBal');
    repBal.textContent = 'جاري الحساب...';
    // load customers
    const cs = await getDocs(query(collection(db,'customers'), orderBy('name','asc'), limit(2000)));
    // for each customer, compute: remaining of invoices (sales - returns) - payments
    const balances = [];
    for(const c of cs.docs){
      const id=c.id; const name=c.data().name||'';
      const invQ = query(collection(db,'invoices'), where('customerId','==',id), limit(2000));
      const invS = await getDocs(invQ);
      let invNet=0;
      invS.forEach(s=>{
        const d=s.data();
        const total = Number(d.grandTotal||0);
        if(d.docType==='return') invNet -= total;
        else invNet += Number(d.remaining||0); // only remaining affects balance
      });

      const payQ = query(collection(db,'payments'), where('customerId','==',id), limit(2000));
      const payS = await getDocs(payQ);
      let pays=0;
      payS.forEach(s=> pays += Number(s.data().amount||0));
      const bal = invNet - pays;
      balances.push({name, bal});
    }
    balances.sort((a,b)=>b.bal-a.bal);
    const top = balances.slice(0,50).map(x=>`${x.name}: ${fmtMoney(x.bal)} ج`).join('\n');
    repBal.textContent = top || 'لا توجد بيانات';
  });
}

const VERSION = '2026.02.19-PRO';

const navItems = [
  {href:'#/dashboard', label:'الرئيسية', perm:'reports_view'},
  {href:'#/invoices', label:'فواتير المبيعات', perm:'invoices_view'},
  {href:'#/returns', label:'مرتجع مبيعات', perm:'returns_view'},
  {href:'#/customers', label:'العملاء', perm:'customers_view'},
  {href:'#/products', label:'الأصناف (قائمة أسعار)', perm:'products_view'},
  {href:'#/payments', label:'الدفعات', perm:'payments_view'},
  {href:'#/reports', label:'التقارير', perm:'reports_view'},
  {href:'#/audit', label:'سجل العمليات', perm:'audit_view', tag:'Admin'},
  {href:'#/company', label:'بيانات الشركة', perm:'company_manage', tag:'Admin'},
  {href:'#/users', label:'المستخدمون والصلاحيات', perm:'users_manage', tag:'Admin'}
];

const elView = document.getElementById('view');
const elNav = document.getElementById('nav');
const elSidebar = document.getElementById('sidebar');
const elChipUser = document.getElementById('chipUser');
const btnLogout = document.getElementById('btnLogout');
document.getElementById('ver').textContent = VERSION;

function openMenu(open=true){
  elSidebar.classList.toggle('open', open);
}
document.getElementById('btnMenu').addEventListener('click', ()=>openMenu(true));
document.getElementById('btnCloseMenu').addEventListener('click', ()=>openMenu(false));
elSidebar.addEventListener('click', (e)=>{
  if(e.target.matches('a')) openMenu(false);
});

let authUser = null;
let me = null;

btnLogout.addEventListener('click', async ()=>{
  await logout();
});

function renderNav(){
  const items = navItems.filter(it=>{
    if(!me) return false;
    return hasPerm(me, it.perm);
  });
  elNav.innerHTML = items.map(it=>{
    const active = location.hash.startsWith(it.href) ? 'active' : '';
    const tag = it.tag ? `<span class="tag">${it.tag}</span>` : '';
    return `<a class="${active}" href="${it.href}">${it.label}${tag}</a>`;
  }).join('');
}

async function route(){
  const hash = location.hash || '#/dashboard';
  const parts = hash.replace(/^#\/?/,'').split('/');
  const r0 = parts[0] || 'dashboard';
  const r1 = parts[1] || '';
  const r2 = parts[2] || '';

  if(!authUser){
    elView.innerHTML = await viewLogin();
    bindLoginForm();
    return;
  }
  if(me && me.active === false){
    elView.innerHTML = `<div class="card pad" style="max-width:720px;margin:24px auto;">
      <div class="h1">الحساب غير مفعل</div>
      <div class="muted">اطلب من الأدمن تفعيل المستخدم داخل شاشة “المستخدمون والصلاحيات”.</div>
      <div class="hr"></div>
      <button class="btn ghost" id="btnLogout2">تسجيل خروج</button>
    </div>`;
    document.getElementById('btnLogout2').onclick=()=>logout();
    return;
  }

  // default route permissions
  try{
    switch(r0){
      case 'dashboard':
        elView.innerHTML = await viewDashboard(me);
        break;

      case 'invoices':
        if(r1==='new'){ location.hash = '#/invoices/new'; }
        if(r1==='new' || r1){
          elView.innerHTML = await viewInvoiceEditor(me, 'sale', r1||'new');
          await bindInvoiceEditor(me,'sale', r1||'new');
        }else{
          elView.innerHTML = await viewInvoices(me,'sale');
        }
        break;

      case 'returns':
        if(r1==='new' || r1){
          elView.innerHTML = await viewInvoiceEditor(me, 'return', r1||'new');
          await bindInvoiceEditor(me,'return', r1||'new');
        }else{
          elView.innerHTML = await viewInvoices(me,'return');
        }
        break;

      case 'customers':
        elView.innerHTML = await viewCustomers(me);
        await bindCustomers(me);
        break;

      case 'products':
        elView.innerHTML = await viewProducts(me);
        await bindProducts(me);
        break;

      case 'payments':
        elView.innerHTML = await viewPayments(me);
        await bindPayments(me);
        break;

      case 'reports':
        elView.innerHTML = await viewReports(me);
        await bindReports(me);
        break;

      case 'company':
        elView.innerHTML = await viewCompany(me);
        await bindCompany(me);
        break;

      case 'users':
        elView.innerHTML = await viewUsers(me);
        await bindUsers(me);
        break;

      case 'audit':
        elView.innerHTML = await viewAudit(me);
        break;

      default:
        location.hash = '#/dashboard';
        return;
    }
  }catch(e){
    console.error(e);
    elView.innerHTML = `<div class="card pad"><div class="h1">حدث خطأ</div><div class="muted">${String(e.message||e)}</div></div>`;
  }

  renderNav();
}

function bindLoginForm(){
  const form = document.getElementById('formLogin');
  if(!form) return;
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(form);
    const email = fd.get('email').toString().trim();
    const password = fd.get('password').toString();
    try{
      await login(email, password);
      toast('تم تسجيل الدخول');
    }catch(err){
      toast('فشل الدخول: تأكد من البيانات');
      console.error(err);
    }
  });
}

watchAuth((u, profile)=>{
  authUser = u;
  me = profile;

  if(!u){
    elChipUser.textContent = 'غير مسجل';
    btnLogout.style.display='none';
    renderNav();
    route();
    return;
  }
  elChipUser.textContent = (profile?.displayName || u.email || 'مستخدم');
  btnLogout.style.display='inline-flex';

  // if no hash set, go dashboard
  if(!location.hash) location.hash = '#/dashboard';
  renderNav();
  route();
});

window.addEventListener('hashchange', ()=>route());
  </script>
</body>
</html>
